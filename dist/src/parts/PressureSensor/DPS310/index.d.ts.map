{"version":3,"sources":["../src/parts/PressureSensor/DPS310/index.ts"],"names":[],"mappings":"AAAA,OAAO,KAAK,MAAM,gBAAgB,CAAC;AAEnC,OAAO,mBAAmB,EAAE,EAAC,cAAc,EAAC,MAAM,oCAAoC,CAAC;AAEvF,MAAM,WAAW,aAAa;CAC7B;AAED,MAAM,CAAC,OAAO,OAAO,MAAO,YAAW,mBAAmB;WAE1C,IAAI,IAAI,cAAc;IAO7B,YAAY,EAAE,MAAM,EAAE,CAAC;IACvB,IAAI,EAAE,MAAM,EAAE,CAAC;IACf,MAAM,EAAE,MAAM,EAAE,CAAC;IACxB,OAAO,CAAC,YAAY,CAElB;IAEF,OAAO,CAAC,cAAc,CAAK;IAC3B,OAAO,CAAC,WAAW,CAAQ;IAC3B,OAAO,CAAC,kBAAkB,CAAK;IAC/B,OAAO,CAAC,mBAAmB,CAAK;IAChC,OAAO,CAAC,mBAAmB,CAAK;IAChC,OAAO,CAAC,oBAAoB,CAAK;IAEjC,OAAO,CAAC,iBAAiB,CAAK;IAC9B,OAAO,CAAC,oBAAoB,CAAM;IAClC,OAAO,CAAC,wBAAwB,CAAM;IACtC,OAAO,CAAC,oBAAoB,CAAM;IAClC,OAAO,CAAC,uBAAuB,CAAM;IACrC,OAAO,CAAC,KAAK,CAAK;IAClB,OAAO,CAAC,MAAM,CAAK;IACnB,OAAO,CAAC,MAAM,CAAK;IACnB,OAAO,CAAC,OAAO,CAAK;IACpB,OAAO,CAAC,cAAc,CAAK;IAC3B,OAAO,CAAC,IAAI,CASV;IACF,OAAO,CAAC,SAAS,CA4Ef;IAEF,OAAO,CAAC,SAAS,CAaf;IACF,OAAO,CAAC,aAAa,CASnB;IACF,OAAO,CAAC,MAAM,CAAM;IACpB,OAAO,CAAC,MAAM,CAAM;IACpB,OAAO,CAAC,KAAK,CAAS;IACtB,OAAO,CAAC,OAAO,CAAM;IACrB,OAAO,CAAC,MAAM,CAAM;IACpB,OAAO,CAAC,GAAG,CAAiB;;IAYrB,KAAK,CAAC,KAAK,EAAE,KAAK;IAYZ,QAAQ,IAAI,OAAO,CAAC,IAAI,CAAC;IAkCzB,uBAAuB,CAAC,gBAAgB,EAAE,GAAG;YAU5C,YAAY;YAOZ,oBAAoB;YAiBpB,aAAa;YASb,aAAa;YASb,iBAAiB;YAOjB,mBAAmB;YAQnB,aAAa;YAYb,WAAW;YAMX,cAAc;YAoBd,kBAAkB;YAgBlB,cAAc;YAmDd,mBAAmB;YAwCnB,wBAAwB;YAKxB,4BAA4B;IAK1C,OAAO,CAAC,YAAY;IAcpB,OAAO,CAAC,QAAQ;YAQF,eAAe;YAUf,mBAAmB;YASnB,WAAW;YAUX,eAAe;CAQ9B","file":"index.d.ts","sourcesContent":["import Obniz from \"../../../obniz\";\r\nimport PeripheralI2C from \"../../../obniz/libs/io_peripherals/i2c\";\r\nimport ObnizPartsInterface, {ObnizPartsInfo} from \"../../../obniz/ObnizPartsInterface\";\r\n\r\nexport interface DPS310Options {\r\n}\r\n\r\nexport default class DPS310 implements ObnizPartsInterface {\r\n\r\n  public static info(): ObnizPartsInfo {\r\n    return {\r\n      name: \"DPS310\",\r\n      datasheet: \"\",\r\n    };\r\n  }\r\n\r\n  public requiredKeys: string[];\r\n  public keys: string[];\r\n  public ioKeys: string[];\r\n  private configration = {\r\n    DPS310__STD_SLAVE_ADDRESS: 0x77,\r\n  };\r\n\r\n  private DPS310__OSR_SE = 3;\r\n  private DPS310__LSB = 0x01;\r\n  private DPS310__PRS_STD_MR = 2;\r\n  private DPS310__PRS_STD_OSR = 3;\r\n  private DPS310__TEMP_STD_MR = 2;\r\n  private DPS310__TEMP_STD_OSR = 3;\r\n\r\n  private DPS310__SUCCEEDED = 0;\r\n  private DPS310__FAIL_UNKNOWN = -1;\r\n  private DPS310__FAIL_INIT_FAILED = -2;\r\n  private DPS310__FAIL_TOOBUSY = -3;\r\n  private DPS310__FAIL_UNFINISHED = -4;\r\n  private prsMr = 0;\r\n  private prsOsr = 0;\r\n  private tempMr = 0;\r\n  private tempOsr = 0;\r\n  private m_lastTempScal = 0;\r\n  private mode = {\r\n    IDLE: 0x00,\r\n    CMD_PRS: 0x01,\r\n    CMD_TEMP: 0x02,\r\n    INVAL_OP_CMD_BOTH: 0x03, // invalid\r\n    INVAL_OP_CONT_NONE: 0x04, // invalid\r\n    CONT_PRS: 0x05,\r\n    CONT_TMP: 0x06,\r\n    CONT_BOTH: 0x07,\r\n  };\r\n  private bitFileds = {\r\n    DPS310__REG_INFO_PROD_ID: {\r\n      address: 0x0d,\r\n      mask: 0x0f,\r\n      shift: 0,\r\n    },\r\n    DPS310__REG_INFO_REV_ID: {\r\n      address: 0x0d,\r\n      mask: 0xf0,\r\n      shift: 4,\r\n    },\r\n    DPS310__REG_INFO_TEMP_SENSORREC: {\r\n      address: 0x28,\r\n      mask: 0x80,\r\n      shift: 7,\r\n    },\r\n    DPS310__REG_INFO_TEMP_SENSOR: {\r\n      address: 0x07,\r\n      mask: 0x80,\r\n      shift: 7,\r\n    },\r\n    DPS310__REG_INFO_OPMODE: {\r\n      address: 0x08,\r\n      mask: 0x07,\r\n      shift: 0,\r\n    },\r\n    DPS310__REG_INFO_FIFO_FL: {\r\n      address: 0x0c,\r\n      mask: 0x80,\r\n      shift: 7,\r\n    },\r\n    DPS310__REG_INFO_FIFO_EN: {\r\n      address: 0x09,\r\n      mask: 0x02,\r\n      shift: 1,\r\n    },\r\n    DPS310__REG_INFO_TEMP_MR: {\r\n      address: 0x07,\r\n      mask: 0x70,\r\n      shift: 4,\r\n    },\r\n    DPS310__REG_INFO_TEMP_OSR: {\r\n      address: 0x07,\r\n      mask: 0x07,\r\n      shift: 0,\r\n    },\r\n    DPS310__REG_INFO_PRS_MR: {\r\n      address: 0x06,\r\n      mask: 0x70,\r\n      shift: 4,\r\n    },\r\n    DPS310__REG_INFO_PRS_OSR: {\r\n      address: 0x06,\r\n      mask: 0x07,\r\n      shift: 0,\r\n    },\r\n    DPS310__REG_INFO_PRS_SE: {\r\n      address: 0x09,\r\n      mask: 0x04,\r\n      shift: 2,\r\n    },\r\n    DPS310__REG_INFO_PRS_RDY: {\r\n      address: 0x08,\r\n      mask: 0x10,\r\n      shift: 4,\r\n    },\r\n    DPS310__REG_INFO_TEMP_SE: {\r\n      address: 0x09,\r\n      mask: 0x08,\r\n      shift: 3,\r\n    },\r\n    DPS310__REG_INFO_TEMP_RDY: {\r\n      address: 0x08,\r\n      mask: 0x20,\r\n      shift: 5,\r\n    },\r\n  };\r\n\r\n  private dataBlock = {\r\n    DPS310__REG_ADR_COEF: {\r\n      address: 0x10,\r\n      length: 18,\r\n    },\r\n    DPS310__REG_ADR_PRS: {\r\n      address: 0x00,\r\n      length: 3,\r\n    },\r\n    DPS310__REG_ADR_TEMP: {\r\n      address: 0x03,\r\n      length: 3,\r\n    },\r\n  };\r\n  private scaling_facts = [\r\n    524288,\r\n    1572864,\r\n    3670016,\r\n    7864320,\r\n    253952,\r\n    516096,\r\n    1040384,\r\n    2088960,\r\n  ];\r\n  private opMode: any;\r\n  private coeffs: any;\r\n  private obniz!: Obniz;\r\n  private address: any;\r\n  private params: any;\r\n  private i2c!: PeripheralI2C;\r\n\r\n  constructor() {\r\n    this.requiredKeys = [\"sda\", \"scl\"];\r\n    this.keys = [\"gpio3\", \"vcc\", \"gnd\", \"scl\", \"sda\"];\r\n    this.ioKeys = [\"gpio3\", \"vcc\", \"gnd\", \"scl\", \"sda\"];\r\n\r\n    this.coeffs = {};\r\n\r\n    this.opMode = this.mode.IDLE;\r\n  }\r\n\r\n  public wired(obniz: Obniz) {\r\n    this.obniz = obniz;\r\n    this.address = 0x77;\r\n    this.params.sda = this.params.sda;\r\n    this.params.scl = this.params.scl;\r\n    this.params.clock = this.params.clock || 100 * 1000;\r\n    this.params.mode = \"master\";\r\n    this.params.pull = \"3v\";\r\n    this.i2c = obniz.getI2CWithConfig(this.params);\r\n    this.obniz.wait(10);\r\n  }\r\n\r\n  public async initWait(): Promise<void> {\r\n    const prodId: any = await this.readByteBitfieldWait(\r\n      this.bitFileds.DPS310__REG_INFO_PROD_ID,\r\n    );\r\n    if (prodId !== 0) {\r\n      throw new Error(\"invalid prodId\");\r\n    }\r\n    await this.readByteBitfieldWait(this.bitFileds.DPS310__REG_INFO_REV_ID);\r\n\r\n    await this.readByteBitfieldWait(\r\n      this.bitFileds.DPS310__REG_INFO_TEMP_SENSORREC,\r\n    );\r\n\r\n    await this.writeByteBitfield(\r\n      this.bitFileds.DPS310__REG_INFO_TEMP_SENSOR,\r\n      0,\r\n    );\r\n\r\n    await this.readCoeffsWait();\r\n    await this.standbyWait();\r\n    await this.configTempWait(\r\n      this.DPS310__TEMP_STD_MR,\r\n      this.DPS310__TEMP_STD_OSR,\r\n    );\r\n    await this.configPressureWait(\r\n      this.DPS310__PRS_STD_MR,\r\n      this.DPS310__PRS_STD_OSR,\r\n    );\r\n    await this.standbyWait();\r\n    await this.measureTempOnceWait();\r\n    await this.standbyWait();\r\n    await this.correctTempWait();\r\n  }\r\n\r\n  public async measurePressureOnceWait(oversamplingRate: any) {\r\n    if (oversamplingRate === undefined) {\r\n      oversamplingRate = this.prsOsr;\r\n    }\r\n    await this.startMeasurePressureOnceWait(oversamplingRate);\r\n    await this.obniz.wait(100);\r\n    const ret: any = await this.getSingleResultWait();\r\n    return ret;\r\n  }\r\n\r\n  private async readByteWait(regAddress: any): Promise<number> {\r\n    this.i2c.write(this.address, [regAddress]);\r\n    await this.obniz.wait(1);\r\n    const results: number[] = await this.i2c.readWait(this.address, 1);\r\n    return results[0];\r\n  }\r\n\r\n  private async readByteBitfieldWait(field: any): Promise<number> {\r\n    const regAddress: any = field.address;\r\n    const mask: any = field.mask;\r\n    const shift: any = field.shift;\r\n    let ret: number = await this.readByteWait(regAddress);\r\n    if (ret < 0) {\r\n      return ret;\r\n    }\r\n    if (mask !== undefined) {\r\n      ret = ret & mask;\r\n    }\r\n    if (shift !== undefined) {\r\n      ret = ret >> shift;\r\n    }\r\n    return ret;\r\n  }\r\n\r\n  private async readBlockWait(datablock: any): Promise<number[]> {\r\n    const address: any = datablock.address;\r\n    const length: any = datablock.length;\r\n    await this.obniz.wait(1);\r\n    this.i2c.write(this.address, [address]);\r\n    const results: number[] = await this.i2c.readWait(this.address, length);\r\n    return results;\r\n  }\r\n\r\n  private async writeByteWait(regAddress: any, data: any, check?: any): Promise<void> {\r\n    this.i2c.write(this.address, [regAddress, data]);\r\n    if (check) {\r\n      if ((await this.readByteWait(regAddress)) !== data) {\r\n        throw new Error(\"DPS310 data write failed\");\r\n      }\r\n    }\r\n  }\r\n\r\n  private async writeByteBitfield(field: any, data: any, check?: any): Promise<void> {\r\n    const old: any = await this.readByteWait(field.address);\r\n    const sendData: any = (old & ~field.mask) | ((data << field.shift) & field.mask);\r\n\r\n    await this.writeByteWait(field.address, sendData, check);\r\n  }\r\n\r\n  private async setOpModeDetailWait(background: any, temperature: any, pressure: any): Promise<void> {\r\n    const opMode: any =\r\n      ((background & this.DPS310__LSB) << 2) |\r\n      ((temperature & this.DPS310__LSB) << 1) |\r\n      (pressure & this.DPS310__LSB);\r\n    return await this.setOpModeWait(opMode);\r\n  }\r\n\r\n  private async setOpModeWait(opMode: any): Promise<void> {\r\n    opMode &=\r\n      this.bitFileds.DPS310__REG_INFO_OPMODE.mask >>\r\n      this.bitFileds.DPS310__REG_INFO_OPMODE.shift;\r\n\r\n    await this.writeByteWait(\r\n      this.bitFileds.DPS310__REG_INFO_OPMODE.address,\r\n      opMode,\r\n    );\r\n    this.opMode = opMode;\r\n  }\r\n\r\n  private async standbyWait(): Promise<void> {\r\n    this.setOpModeWait(this.mode.IDLE);\r\n    await this.writeByteBitfield(this.bitFileds.DPS310__REG_INFO_FIFO_FL, 1);\r\n    await this.writeByteBitfield(this.bitFileds.DPS310__REG_INFO_FIFO_EN, 0);\r\n  }\r\n\r\n  private async configTempWait(tempMr: any, tempOsr: any): Promise<void> {\r\n    await this.writeByteBitfield(\r\n      this.bitFileds.DPS310__REG_INFO_TEMP_MR,\r\n      tempMr,\r\n    );\r\n    await this.writeByteBitfield(\r\n      this.bitFileds.DPS310__REG_INFO_TEMP_OSR,\r\n      tempOsr,\r\n    );\r\n\r\n    if (tempOsr > this.DPS310__OSR_SE) {\r\n      await this.writeByteBitfield(this.bitFileds.DPS310__REG_INFO_TEMP_SE, 1);\r\n    } else {\r\n      await this.writeByteBitfield(this.bitFileds.DPS310__REG_INFO_TEMP_SE, 0);\r\n    }\r\n\r\n    this.tempMr = tempMr;\r\n    this.tempOsr = tempOsr;\r\n  }\r\n\r\n  private async configPressureWait(prsMr: any, prsOsr: any): Promise<void> {\r\n    await this.writeByteBitfield(this.bitFileds.DPS310__REG_INFO_PRS_MR, prsMr);\r\n    await this.writeByteBitfield(\r\n      this.bitFileds.DPS310__REG_INFO_PRS_OSR,\r\n      prsOsr,\r\n    );\r\n\r\n    if (prsOsr > this.DPS310__OSR_SE) {\r\n      await this.writeByteBitfield(this.bitFileds.DPS310__REG_INFO_PRS_SE, 1);\r\n    } else {\r\n      await this.writeByteBitfield(this.bitFileds.DPS310__REG_INFO_PRS_SE, 0);\r\n    }\r\n    this.prsMr = prsMr;\r\n    this.prsOsr = prsOsr;\r\n  }\r\n\r\n  private async readCoeffsWait(): Promise<void> {\r\n    const buffer: any = await this.readBlockWait(this.dataBlock.DPS310__REG_ADR_COEF);\r\n\r\n    this.coeffs.m_c0Half = (buffer[0] << 4) | ((buffer[1] >> 4) & 0x0f);\r\n    if (this.coeffs.m_c0Half & (1 << 11)) {\r\n      this.coeffs.m_c0Half -= 1 << 12;\r\n    }\r\n    this.coeffs.m_c0Half = this.coeffs.m_c0Half / 2;\r\n\r\n    this.coeffs.m_c1 = ((buffer[1] & 0x0f) << 8) | buffer[2];\r\n    if (this.coeffs.m_c1 & (1 << 11)) {\r\n      this.coeffs.m_c1 -= 1 << 12;\r\n    }\r\n    this.coeffs.m_c00 =\r\n      (buffer[3] << 12) | (buffer[4] << 4) | ((buffer[5] >> 4) & 0x0f);\r\n    if (this.coeffs.m_c00 & (1 << 19)) {\r\n      this.coeffs.m_c00 -= 1 << 20;\r\n    }\r\n\r\n    this.coeffs.m_c10 =\r\n      ((buffer[5] & 0x0f) << 16) | (buffer[6] << 8) | buffer[7];\r\n    if (this.coeffs.m_c10 & (1 << 19)) {\r\n      this.coeffs.m_c10 -= 1 << 20;\r\n    }\r\n\r\n    this.coeffs.m_c01 = (buffer[8] << 8) | buffer[9];\r\n    if (this.coeffs.m_c01 & (1 << 15)) {\r\n      this.coeffs.m_c01 -= 1 << 16;\r\n    }\r\n\r\n    this.coeffs.m_c11 = (buffer[10] << 8) | buffer[11];\r\n    if (this.coeffs.m_c11 & (1 << 15)) {\r\n      this.coeffs.m_c11 -= 1 << 16;\r\n    }\r\n\r\n    this.coeffs.m_c20 = (buffer[12] << 8) | buffer[13];\r\n    if (this.coeffs.m_c20 & (1 << 15)) {\r\n      this.coeffs.m_c20 -= 1 << 16;\r\n    }\r\n\r\n    this.coeffs.m_c21 = (buffer[14] << 8) | buffer[15];\r\n    if (this.coeffs.m_c21 & (1 << 15)) {\r\n      this.coeffs.m_c21 -= 1 << 16;\r\n    }\r\n\r\n    this.coeffs.m_c30 = (buffer[16] << 8) | buffer[17];\r\n    if (this.coeffs.m_c30 & (1 << 15)) {\r\n      this.coeffs.m_c30 -= 1 << 16;\r\n    }\r\n  }\r\n\r\n  private async getSingleResultWait(): Promise<number> {\r\n    let rdy: any;\r\n    switch (this.opMode) {\r\n      case this.mode.CMD_TEMP:\r\n        rdy = await this.readByteBitfieldWait(\r\n          this.bitFileds.DPS310__REG_INFO_TEMP_RDY,\r\n        );\r\n        break;\r\n      case this.mode.CMD_PRS:\r\n        rdy = await this.readByteBitfieldWait(\r\n          this.bitFileds.DPS310__REG_INFO_PRS_RDY,\r\n        );\r\n        break;\r\n      default:\r\n        return this.DPS310__FAIL_TOOBUSY;\r\n    }\r\n\r\n    let oldMode: any;\r\n    switch (rdy) {\r\n      case this.DPS310__FAIL_UNKNOWN:\r\n        throw new Error(\"DPS310__FAIL_UNKNOWN\");\r\n      case 0:\r\n        return this.obniz.wait(10).then(() => {\r\n          return this.getSingleResultWait();\r\n        });\r\n      case 1:\r\n        oldMode = this.opMode;\r\n        this.opMode = this.mode.IDLE;\r\n        switch (oldMode) {\r\n          case this.mode.CMD_TEMP:\r\n            return await this.getTempWait();\r\n          case this.mode.CMD_PRS:\r\n            return await this.getPressureWait();\r\n          default:\r\n            throw new Error(\"DPS310__FAIL_UNKNOWN\");\r\n        }\r\n    }\r\n    throw new Error(\"DPS310__FAIL_UNKNOWN\");\r\n  }\r\n\r\n  private async startMeasureTempOnceWait(oversamplingRate: any): Promise<void> {\r\n    await this.configTempWait(0, oversamplingRate);\r\n    await this.setOpModeDetailWait(0, 1, 0);\r\n  }\r\n\r\n  private async startMeasurePressureOnceWait(oversamplingRate: any): Promise<void> {\r\n    await this.configPressureWait(0, oversamplingRate);\r\n    await this.setOpModeDetailWait(0, 0, 1);\r\n  }\r\n\r\n  private calcPressure(raw: any): number {\r\n    let prs: any = raw;\r\n    prs /= this.scaling_facts[this.prsOsr];\r\n    prs =\r\n      this.coeffs.m_c00 +\r\n      prs *\r\n      (this.coeffs.m_c10 +\r\n        prs * (this.coeffs.m_c20 + prs * this.coeffs.m_c30)) +\r\n      this.m_lastTempScal *\r\n      (this.coeffs.m_c01 +\r\n        prs * (this.coeffs.m_c11 + prs * this.coeffs.m_c21));\r\n    return prs;\r\n  }\r\n\r\n  private calcTemp(raw: any): number {\r\n    let temp: any = raw;\r\n    temp /= this.scaling_facts[this.tempOsr];\r\n    this.m_lastTempScal = temp;\r\n    temp = this.coeffs.m_c0Half + this.coeffs.m_c1 * temp;\r\n    return temp;\r\n  }\r\n\r\n  private async correctTempWait(): Promise<void> {\r\n    this.writeByteWait(0x0e, 0xe5);\r\n    this.writeByteWait(0x0f, 0x96);\r\n    this.writeByteWait(0x62, 0x02);\r\n    this.writeByteWait(0x0e, 0x00);\r\n    this.writeByteWait(0x0f, 0x00);\r\n\r\n    await this.measureTempOnceWait();\r\n  }\r\n\r\n  private async measureTempOnceWait(oversamplingRate?: any): Promise<number> {\r\n    if (oversamplingRate === undefined) {\r\n      oversamplingRate = this.tempOsr;\r\n    }\r\n    await this.startMeasureTempOnceWait(oversamplingRate);\r\n    await this.obniz.wait(100);\r\n    return await this.getSingleResultWait();\r\n  }\r\n\r\n  private async getTempWait(): Promise<number> {\r\n    const data: any = await this.readBlockWait(this.dataBlock.DPS310__REG_ADR_TEMP);\r\n\r\n    let temp: any = (data[0] << 16) | (data[1] << 8) | data[2];\r\n    if (temp & (1 << 23)) {\r\n      temp -= 1 << 24;\r\n    }\r\n    return this.calcTemp(temp);\r\n  }\r\n\r\n  private async getPressureWait(): Promise<number> {\r\n    const data: any = await this.readBlockWait(this.dataBlock.DPS310__REG_ADR_PRS);\r\n    let prs: any = (data[0] << 16) | (data[1] << 8) | data[2];\r\n    if (prs & (1 << 23)) {\r\n      prs -= 1 << 24;\r\n    }\r\n    return this.calcPressure(prs);\r\n  }\r\n}\r\n"]}