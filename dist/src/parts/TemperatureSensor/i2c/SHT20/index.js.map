{"version":3,"sources":["../src/parts/TemperatureSensor/i2c/SHT20/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import Obniz from \"../../../../obniz\";\r\nimport PeripheralI2C from \"../../../../obniz/libs/io_peripherals/i2c\";\r\nimport ObnizPartsInterface, {ObnizPartsInfo} from \"../../../../obniz/ObnizPartsInterface\";\r\nimport {I2cPartsAbstructOptions} from \"../../../i2cParts\";\r\n\r\nexport interface SHT20Options extends I2cPartsAbstructOptions {\r\n}\r\n\r\nexport default class SHT20 implements ObnizPartsInterface {\r\n\r\n  public static info(): ObnizPartsInfo {\r\n    return {\r\n      name: \"SHT20\",\r\n    };\r\n  }\r\n\r\n  public requiredKeys: string[];\r\n  public keys: string[];\r\n  public params: any;\r\n\r\n  public ioKeys: string[];\r\n  public commands: {[key: string]: [number]};\r\n  public address!: number;\r\n\r\n  protected obniz!: Obniz;\r\n  protected i2c!: PeripheralI2C;\r\n\r\n  constructor() {\r\n    this.requiredKeys = [];\r\n    this.keys = [\r\n      \"vcc\",\r\n      \"sda\",\r\n      \"scl\",\r\n      \"gnd\",\r\n      \"i2c\",\r\n      \"pull\",\r\n    ];\r\n\r\n    this.ioKeys = [\"vcc\", \"sda\", \"scl\", \"gnd\"];\r\n    this.commands = {};\r\n    this.commands.softReset = [0xfe];\r\n    this.commands.tempNoHold = [0xf3];\r\n    this.commands.humidityNoHold = [0xf5];\r\n  }\r\n\r\n  public wired(obniz: Obniz) {\r\n    this.obniz = obniz;\r\n    this.obniz.setVccGnd(this.params.vcc, this.params.gnd, \"3v\");\r\n    this.address = 0x40;\r\n\r\n    this.params.clock = this.params.clock || 100 * 1000; // for i2c\r\n    this.params.mode = this.params.mode || \"master\"; // for i2c\r\n    this.params.pull = this.params.pull || \"3v\"; // for i2c\r\n    this.i2c = obniz.getI2CWithConfig(this.params);\r\n    this.i2c.write(this.address, this.commands.softReset);\r\n    this.obniz.wait(50);\r\n  }\r\n\r\n  public async getData(command: [number]): Promise<number> {\r\n    this.i2c.write(this.address, command);\r\n\r\n    await this.obniz.wait(100);\r\n    const data: number[] = await this.i2c.readWait(this.address, 3);\r\n\r\n    const rawValue = (data[0] << 8) | data[1];\r\n    if (this.checkCRC(rawValue, data[2]) !== 0) {\r\n      return -2;\r\n    }\r\n    return rawValue & 0xFFFC;\r\n  }\r\n\r\n  public async getTempWait(): Promise<number> {\r\n    const rawTemperature = await this.getData(this.commands.tempNoHold);\r\n    if (rawTemperature < 0) {\r\n      console.log(\"error sht20\", rawTemperature);\r\n      return(rawTemperature);\r\n    }\r\n    return rawTemperature * (175.72 / 65536.0) - 46.85;\r\n  }\r\n\r\n  public async getHumidWait(): Promise<number> {\r\n    const rawHumidity  = await this.getData(this.commands.humidityNoHold);\r\n    if (rawHumidity  < 0) {\r\n      console.log(\"error sht20\", rawHumidity );\r\n      return(rawHumidity);\r\n    }\r\n    return rawHumidity * (125.0 / 65536.0) - 6.0;\r\n  }\r\n\r\n  private checkCRC(message_from_sensor: number, check_value_from_sensor: number): number {\r\n    let remainder = message_from_sensor << 8;\r\n    remainder |= check_value_from_sensor;\r\n    let divsor = 0x988000;\r\n    for (let i = 0; i < 16; i++) {\r\n      if (remainder & 1 << (23 - i)) {\r\n        remainder ^= divsor;\r\n      }\r\n      divsor >>= 1;\r\n    }\r\n    return remainder;\r\n  }\r\n\r\n}\r\n"]}