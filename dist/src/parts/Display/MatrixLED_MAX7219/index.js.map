{"version":3,"sources":["../src/parts/Display/MatrixLED_MAX7219/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import Obniz from \"../../../obniz\";\r\nimport PeripheralIO from \"../../../obniz/libs/io_peripherals/io\";\r\nimport PeripheralSPI from \"../../../obniz/libs/io_peripherals/spi\";\r\nimport ObnizPartsInterface, {ObnizPartsInfo} from \"../../../obniz/ObnizPartsInterface\";\r\n\r\nexport interface MatrixLED_MAX7219Options {\r\n  clk: number;\r\n  cs: number;\r\n  din: number;\r\n  gnd?: number;\r\n  vcc?: number;\r\n}\r\n\r\nexport default class MatrixLED_MAX7219 implements ObnizPartsInterface {\r\n\r\n  public static info(): ObnizPartsInfo {\r\n    return {\r\n      name: \"MatrixLED_MAX7219\",\r\n    };\r\n  }\r\n\r\n  public keys: string[];\r\n  public requiredKeys: string[];\r\n  public cs!: PeripheralIO;\r\n  public params: any;\r\n  public spi!: PeripheralSPI;\r\n  public obniz!: Obniz;\r\n  public width: number = 0;\r\n  public height: number = 0;\r\n  public vram: number[][] = [[]];\r\n\r\n  constructor() {\r\n    this.keys = [\"vcc\", \"gnd\", \"din\", \"cs\", \"clk\"];\r\n    this.requiredKeys = [\"din\", \"cs\", \"clk\"];\r\n  }\r\n\r\n  public wired(obniz: Obniz) {\r\n    this.cs = obniz.getIO(this.params.cs);\r\n    // logich high must 3.5v <=\r\n    if (obniz.isValidIO(this.params.vcc)) {\r\n      obniz.getIO(this.params.vcc).output(true);\r\n    }\r\n    if (obniz.isValidIO(this.params.gnd)) {\r\n      obniz.getIO(this.params.gnd).output(false);\r\n    }\r\n\r\n    // max 10Mhz but motor driver can't\r\n    this.params.frequency = this.params.frequency || 10 * 1000 * 1000;\r\n    this.params.mode = \"master\";\r\n    this.params.mosi = this.params.din;\r\n    this.params.drive = \"3v\";\r\n    this.spi = this.obniz.getSpiWithConfig(this.params);\r\n\r\n    // reset a onece\r\n    this.cs.output(true);\r\n    this.cs.output(false);\r\n    this.cs.output(true);\r\n  }\r\n\r\n  public init(width: number, height: number) {\r\n    this.width = width;\r\n    this.height = height;\r\n    this.preparevram(width, height);\r\n    this.initModule();\r\n  }\r\n\r\n  public initModule() {\r\n    this.write([0x09, 0x00]); // Code B decode for digits 3-0 No decode for digits 7-4\r\n    this.write([0x0a, 0x05]); // brightness 9/32 0 to f\r\n    this.write([0x0b, 0x07]); // Display digits 0 1 2 3 4 567\r\n    this.write([0x0c, 0x01]); // Shutdown to normal operation\r\n    this.write([0x0f, 0x00]);\r\n    this.passingCommands();\r\n    this.obniz.wait(10);\r\n  }\r\n\r\n  public test() {\r\n    this.write([0x0f, 0x00]); // test command\r\n    this.passingCommands();\r\n  }\r\n\r\n  public passingCommands() {\r\n    for (let i = 8; i < this.width; i += 8) {\r\n      // this needed for number of unit\r\n      this.write([0x00, 0x00]);\r\n    }\r\n  }\r\n\r\n  public brightness(val: number) {\r\n    this.write([0x0a, val]); // 0 to 15;\r\n    this.passingCommands();\r\n  }\r\n\r\n  public preparevram(width: number, height: number) {\r\n    this.vram = [];\r\n    for (let i = 0; i < height; i++) {\r\n      const dots: number[] = new Array(width / 8);\r\n      for (let ii = 0; ii < dots.length; ii++) {\r\n        dots[ii] = 0x00;\r\n      }\r\n      this.vram.push(dots);\r\n    }\r\n  }\r\n\r\n  public write(data: number[]) {\r\n    this.cs.output(false);\r\n    this.spi.write(data);\r\n    this.cs.output(true);\r\n  }\r\n\r\n  public writeVram() {\r\n    for (let line_num = 0; line_num < this.height; line_num++) {\r\n      const addr = line_num + 1;\r\n      const line = this.vram[line_num];\r\n      const data: number[] = [];\r\n      for (let col = 0; col < line.length; col++) {\r\n        data.push(addr);\r\n        data.push(line[col]);\r\n      }\r\n      this.write(data);\r\n    }\r\n  }\r\n\r\n  public clear() {\r\n    for (let line_num = 0; line_num < this.height; line_num++) {\r\n      const line = this.vram[line_num];\r\n      for (let col = 0; col < line.length; col++) {\r\n        this.vram[line_num][col] = 0x00;\r\n      }\r\n      this.writeVram();\r\n    }\r\n  }\r\n\r\n  public draw(ctx: CanvasRenderingContext2D) {\r\n    const imageData = ctx.getImageData(0, 0, this.width, this.height);\r\n    const data = imageData.data;\r\n\r\n    for (let i = 0; i < data.length; i += 4) {\r\n      const brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];\r\n      const index = Math.floor(i / 4);\r\n      const line = Math.floor(index / this.width);\r\n      const col = Math.floor((index - line * this.width) / 8);\r\n      const bits = Math.floor(index - line * this.width) % 8;\r\n      if (bits === 0) {\r\n        this.vram[line][col] = 0x00;\r\n      }\r\n      if (brightness > 0x7f) {\r\n        this.vram[line][col] |= 0x80 >> bits;\r\n      }\r\n    }\r\n\r\n    this.writeVram();\r\n  }\r\n}\r\n"]}