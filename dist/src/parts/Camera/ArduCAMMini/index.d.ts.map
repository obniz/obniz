{"version":3,"sources":["../src/parts/Camera/ArduCAMMini/index.ts"],"names":[],"mappings":"AAAA;;;GAGG;AAEH,OAAO,KAAK,MAAM,gBAAgB,CAAC;AACnC,OAAO,EAAC,SAAS,EAAC,MAAM,2CAA2C,CAAC;AACpE,OAAO,YAAY,MAAM,uCAAuC,CAAC;AAEjE,OAAO,aAAa,MAAM,wCAAwC,CAAC;AACnE,OAAO,aAAa,MAAM,wCAAwC,CAAC;AACnE,OAAO,mBAAmB,EAAE,EAAC,cAAc,EAAC,MAAM,oCAAoC,CAAC;AAEvF;;GAEG;AACH,MAAM,WAAY,kBAAkB;IAClC,EAAE,EAAE,YAAY,CAAC;IACjB,IAAI,CAAC,EAAE,YAAY,CAAC;IACpB,IAAI,CAAC,EAAE,YAAY,CAAC;IACpB,IAAI,CAAC,EAAE,YAAY,CAAC;IACpB,GAAG,CAAC,EAAE,YAAY,CAAC;IACnB,GAAG,CAAC,EAAE,YAAY,CAAC;IACnB,GAAG,CAAC,EAAE,YAAY,CAAC;IACnB,GAAG,CAAC,EAAE,YAAY,CAAC;IACnB,GAAG,CAAC,EAAE,aAAa,CAAC;IACpB,GAAG,CAAC,EAAE,aAAa,CAAC;IACpB,SAAS,CAAC,EAAE,SAAS,CAAC;IACtB,aAAa,CAAC,EAAE,MAAM,CAAC;IACvB,cAAc,CAAC,EAAE,MAAM,CAAC;CACzB;AAED,oBAAY,eAAe,GAAG,SAAS,GAAG,SAAS,GAAG,SAAS,CAAC;AAChE,oBAAY,eAAe,GACvB,SAAS,GACT,SAAS,GACT,SAAS,GACT,SAAS,GACT,SAAS,GACT,SAAS,GACT,UAAU,GACV,UAAU,GACV,WAAW,CAAC;AAEhB,MAAM,CAAC,OAAO,OAAO,WAAY,YAAW,mBAAmB;WAE/C,IAAI,IAAI,cAAc;IAM7B,IAAI,EAAE,MAAM,EAAE,CAAC;IACf,YAAY,EAAE,MAAM,EAAE,CAAC;IACvB,MAAM,EAAE,MAAM,EAAE,CAAC;IACjB,WAAW,EAAE,MAAM,CAAC;IACpB,IAAI,EAAE,GAAG,CAAC;IACV,OAAO,EAAE,GAAG,CAAC;IACb,KAAK,EAAG,KAAK,CAAC;IACd,MAAM,EAAE,GAAG,CAAC;IACZ,KAAK,EAAE,GAAG,CAAC;IACX,WAAW,EAAE,GAAG,CAAC;IACjB,KAAK,EAAE,GAAG,CAAC;IAClB,SAAS,CAAC,GAAG,EAAG,aAAa,CAAC;IAC9B,SAAS,CAAC,GAAG,EAAG,aAAa,CAAC;;IAgpBvB,KAAK,CAAC,KAAK,EAAE,KAAK;IAyBlB,SAAS,CAAC,IAAI,EAAE,MAAM,EAAE,QAAQ,EAAE,MAAM;IASlC,YAAY,CAAC,IAAI,EAAE,MAAM;IAU/B,cAAc,CAAC,IAAI,EAAE,MAAM,EAAE,QAAQ,EAAE,MAAM;IAI7C,cAAc,CAAC,IAAI,EAAE,MAAM,EAAE;IAM7B,aAAa,CAAC,IAAI,EAAE,MAAM,EAAE,QAAQ,EAAE,MAAM;IAItC,gBAAgB,CAAC,IAAI,EAAE,MAAM;IAI7B,gBAAgB;IAStB,OAAO,CAAC,IAAI,EAAE,MAAM;IAYd,aAAa,IAAI,OAAO,CAAC,MAAM,CAAC;IAQtC,IAAI;IAaE,WAAW;IAUX,QAAQ,CAAC,IAAI,EAAE,MAAM,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;IAiB/C,OAAO,CAAC,MAAM,EAAE,MAAM;IAuBtB,UAAU,CAAC,IAAI,EAAE,GAAG;IAQpB,SAAS;IAIH,kBAAkB,IAAI,OAAO,CAAC,MAAM,CAAC;IAO3C,YAAY;IAIN,iBAAiB,IAAI,OAAO,CAAC,OAAO,CAAC;IAMrC,YAAY,IAAI,OAAO,CAAC,MAAM,EAAE,CAAC;IA8BvC,aAAa,CAAC,KAAK,EAAE,MAAM,EAAE,GAAG,MAAM;CAG9C","file":"index.d.ts","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.ArduCAMMini\n */\n\nimport Obniz from \"../../../obniz\";\nimport {DriveType} from \"../../../obniz/libs/io_peripherals/common\";\nimport PeripheralIO from \"../../../obniz/libs/io_peripherals/io\";\n\nimport PeripheralI2C from \"../../../obniz/libs/io_peripherals/i2c\";\nimport PeripheralSPI from \"../../../obniz/libs/io_peripherals/spi\";\nimport ObnizPartsInterface, {ObnizPartsInfo} from \"../../../obniz/ObnizPartsInterface\";\n\n/**\n * @category Parts.ArduCAMMini\n */\nexport interface  ArduCAMMiniOptions {\n  cs: PeripheralIO;\n  mosi?: PeripheralIO;\n  miso?: PeripheralIO;\n  sclk?: PeripheralIO;\n  gnd?: PeripheralIO;\n  vcc?: PeripheralIO;\n  sda?: PeripheralIO;\n  scl?: PeripheralIO;\n  i2c?: PeripheralI2C;\n  spi?: PeripheralSPI;\n  spi_drive?: DriveType;\n  spi_frequency?: number;\n  module_version?: number;\n}\n\nexport type ArduCAMMiniMode = \"MCU2LCD\" | \"CAM2LCD\" | \"LCD2MCU\";\nexport type ArduCAMMiniSize =\n  | \"160x120\"\n  | \"176x144\"\n  | \"320x240\"\n  | \"352x288\"\n  | \"640x480\"\n  | \"800x600\"\n  | \"1024x768\"\n  | \"1280x960\"\n  | \"1600x1200\";\n\nexport default class ArduCAMMini implements ObnizPartsInterface {\n\n  public static info(): ObnizPartsInfo {\n    return {\n      name: \"ArduCAMMini\",\n    };\n  }\n\n  public keys: string[];\n  public requiredKeys: string[];\n  public ioKeys: string[];\n  public displayName: string;\n  public regs: any;\n  public configs: any;\n  public obniz!: Obniz;\n  public params: any;\n  public io_cs: any;\n  public sensor_addr: any;\n  public _size: any;\n  protected spi!: PeripheralSPI;\n  protected i2c!: PeripheralI2C;\n\n  constructor() {\n    this.keys = [\n      \"cs\",\n      \"mosi\",\n      \"miso\",\n      \"sclk\",\n      \"gnd\",\n      \"vcc\",\n      \"sda\",\n      \"scl\",\n      \"spi\",\n      \"i2c\",\n      \"spi_frequency\",\n      \"spi_drive\",\n      \"module_version\",\n    ];\n    this.requiredKeys = [\"cs\"];\n\n    this.ioKeys = this.keys;\n    this.displayName = \"Cam\";\n\n    this.regs = {\n      ARDUCHIP_TEST1: 0x00,\n      ARDUCHIP_MODE: 0x02,\n      ARDUCHIP_FIFO: 0x04,\n      BURST_FIFO_READ: 0x3c,\n      ARDUCHIP_TRIG: 0x41,\n      FIFO_SIZE1: 0x42,\n      FIFO_SIZE2: 0x43,\n      FIFO_SIZE3: 0x44,\n    };\n\n    this.configs = {\n      OV2640_JPEG_INIT: [\n        [0xff, 0x00],\n        [0x2c, 0xff],\n        [0x2e, 0xdf],\n        [0xff, 0x01],\n        [0x3c, 0x32],\n        [0x11, 0x04],\n        [0x09, 0x02],\n        [0x04, 0x28],\n        [0x13, 0xe5],\n        [0x14, 0x48],\n        [0x2c, 0x0c],\n        [0x33, 0x78],\n        [0x3a, 0x33],\n        [0x3b, 0xfb],\n        [0x3e, 0x00],\n        [0x43, 0x11],\n        [0x16, 0x10],\n        [0x39, 0x92],\n        [0x35, 0xda],\n        [0x22, 0x1a],\n        [0x37, 0xc3],\n        [0x23, 0x00],\n        [0x34, 0xc0],\n        [0x36, 0x1a],\n        [0x06, 0x88],\n        [0x07, 0xc0],\n        [0x0d, 0x87],\n        [0x0e, 0x41],\n        [0x4c, 0x00],\n        [0x48, 0x00],\n        [0x5b, 0x00],\n        [0x42, 0x03],\n        [0x4a, 0x81],\n        [0x21, 0x99],\n        [0x24, 0x40],\n        [0x25, 0x38],\n        [0x26, 0x82],\n        [0x5c, 0x00],\n        [0x63, 0x00],\n        [0x61, 0x70],\n        [0x62, 0x80],\n        [0x7c, 0x05],\n        [0x20, 0x80],\n        [0x28, 0x30],\n        [0x6c, 0x00],\n        [0x6d, 0x80],\n        [0x6e, 0x00],\n        [0x70, 0x02],\n        [0x71, 0x94],\n        [0x73, 0xc1],\n        [0x12, 0x40],\n        [0x17, 0x11],\n        [0x18, 0x43],\n        [0x19, 0x00],\n        [0x1a, 0x4b],\n        [0x32, 0x09],\n        [0x37, 0xc0],\n        [0x4f, 0x60],\n        [0x50, 0xa8],\n        [0x6d, 0x00],\n        [0x3d, 0x38],\n        [0x46, 0x3f],\n        [0x4f, 0x60],\n        [0x0c, 0x3c],\n        [0xff, 0x00],\n        [0xe5, 0x7f],\n        [0xf9, 0xc0],\n        [0x41, 0x24],\n        [0xe0, 0x14],\n        [0x76, 0xff],\n        [0x33, 0xa0],\n        [0x42, 0x20],\n        [0x43, 0x18],\n        [0x4c, 0x00],\n        [0x87, 0xd5],\n        [0x88, 0x3f],\n        [0xd7, 0x03],\n        [0xd9, 0x10],\n        [0xd3, 0x82],\n        [0xc8, 0x08],\n        [0xc9, 0x80],\n        [0x7c, 0x00],\n        [0x7d, 0x00],\n        [0x7c, 0x03],\n        [0x7d, 0x48],\n        [0x7d, 0x48],\n        [0x7c, 0x08],\n        [0x7d, 0x20],\n        [0x7d, 0x10],\n        [0x7d, 0x0e],\n        [0x90, 0x00],\n        [0x91, 0x0e],\n        [0x91, 0x1a],\n        [0x91, 0x31],\n        [0x91, 0x5a],\n        [0x91, 0x69],\n        [0x91, 0x75],\n        [0x91, 0x7e],\n        [0x91, 0x88],\n        [0x91, 0x8f],\n        [0x91, 0x96],\n        [0x91, 0xa3],\n        [0x91, 0xaf],\n        [0x91, 0xc4],\n        [0x91, 0xd7],\n        [0x91, 0xe8],\n        [0x91, 0x20],\n        [0x92, 0x00],\n        [0x93, 0x06],\n        [0x93, 0xe3],\n        [0x93, 0x05],\n        [0x93, 0x05],\n        [0x93, 0x00],\n        [0x93, 0x04],\n        [0x93, 0x00],\n        [0x93, 0x00],\n        [0x93, 0x00],\n        [0x93, 0x00],\n        [0x93, 0x00],\n        [0x93, 0x00],\n        [0x93, 0x00],\n        [0x96, 0x00],\n        [0x97, 0x08],\n        [0x97, 0x19],\n        [0x97, 0x02],\n        [0x97, 0x0c],\n        [0x97, 0x24],\n        [0x97, 0x30],\n        [0x97, 0x28],\n        [0x97, 0x26],\n        [0x97, 0x02],\n        [0x97, 0x98],\n        [0x97, 0x80],\n        [0x97, 0x00],\n        [0x97, 0x00],\n        [0xc3, 0xed],\n        [0xa4, 0x00],\n        [0xa8, 0x00],\n        [0xc5, 0x11],\n        [0xc6, 0x51],\n        [0xbf, 0x80],\n        [0xc7, 0x10],\n        [0xb6, 0x66],\n        [0xb8, 0xa5],\n        [0xb7, 0x64],\n        [0xb9, 0x7c],\n        [0xb3, 0xaf],\n        [0xb4, 0x97],\n        [0xb5, 0xff],\n        [0xb0, 0xc5],\n        [0xb1, 0x94],\n        [0xb2, 0x0f],\n        [0xc4, 0x5c],\n        [0xc0, 0x64],\n        [0xc1, 0x4b],\n        [0x8c, 0x00],\n        [0x86, 0x3d],\n        [0x50, 0x00],\n        [0x51, 0xc8],\n        [0x52, 0x96],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x00],\n        [0x5a, 0xc8],\n        [0x5b, 0x96],\n        [0x5c, 0x00],\n        [0xd3, 0x00], // [ 0xd3, 0x7f ],\n        [0xc3, 0xed],\n        [0x7f, 0x00],\n        [0xda, 0x00],\n        [0xe5, 0x1f],\n        [0xe1, 0x67],\n        [0xe0, 0x00],\n        [0xdd, 0x7f],\n        [0x05, 0x00],\n        //\n        [0x12, 0x40],\n        [0xd3, 0x04], // [ 0xd3, 0x7f ],\n        [0xc0, 0x16],\n        [0xc1, 0x12],\n        [0x8c, 0x00],\n        [0x86, 0x3d],\n        [0x50, 0x00],\n        [0x51, 0x2c],\n        [0x52, 0x24],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x00],\n        [0x5a, 0x2c],\n        [0x5b, 0x24],\n        [0x5c, 0x00],\n        [0xff, 0xff],\n      ],\n\n      OV2640_YUV422: [\n        [0xff, 0x00],\n        [0x05, 0x00],\n        [0xda, 0x10],\n        [0xd7, 0x03],\n        [0xdf, 0x00],\n        [0x33, 0x80],\n        [0x3c, 0x40],\n        [0xe1, 0x77],\n        [0x00, 0x00],\n        [0xff, 0xff],\n      ],\n\n      OV2640_JPEG: [\n        [0xe0, 0x14],\n        [0xe1, 0x77],\n        [0xe5, 0x1f],\n        [0xd7, 0x03],\n        [0xda, 0x10],\n        [0xe0, 0x00],\n        [0xff, 0x01],\n        [0x04, 0x08],\n        [0xff, 0xff],\n      ],\n\n      OV2640_160x120_JPEG: [\n        [0xff, 0x01],\n        [0x12, 0x40],\n        [0x17, 0x11],\n        [0x18, 0x43],\n        [0x19, 0x00],\n        [0x1a, 0x4b],\n        [0x32, 0x09],\n        [0x4f, 0xca],\n        [0x50, 0xa8],\n        [0x5a, 0x23],\n        [0x6d, 0x00],\n        [0x39, 0x12],\n        [0x35, 0xda],\n        [0x22, 0x1a],\n        [0x37, 0xc3],\n        [0x23, 0x00],\n        [0x34, 0xc0],\n        [0x36, 0x1a],\n        [0x06, 0x88],\n        [0x07, 0xc0],\n        [0x0d, 0x87],\n        [0x0e, 0x41],\n        [0x4c, 0x00],\n        [0xff, 0x00],\n        [0xe0, 0x04],\n        [0xc0, 0x64],\n        [0xc1, 0x4b],\n        [0x86, 0x35],\n        [0x50, 0x92],\n        [0x51, 0xc8],\n        [0x52, 0x96],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x00],\n        [0x57, 0x00],\n        [0x5a, 0x28],\n        [0x5b, 0x1e],\n        [0x5c, 0x00],\n        [0xe0, 0x00],\n        [0xff, 0xff],\n      ],\n\n      OV2640_176x144_JPEG: [\n        [0xff, 0x01],\n        [0x12, 0x40],\n        [0x17, 0x11],\n        [0x18, 0x43],\n        [0x19, 0x00],\n        [0x1a, 0x4b],\n        [0x32, 0x09],\n        [0x4f, 0xca],\n        [0x50, 0xa8],\n        [0x5a, 0x23],\n        [0x6d, 0x00],\n        [0x39, 0x12],\n        [0x35, 0xda],\n        [0x22, 0x1a],\n        [0x37, 0xc3],\n        [0x23, 0x00],\n        [0x34, 0xc0],\n        [0x36, 0x1a],\n        [0x06, 0x88],\n        [0x07, 0xc0],\n        [0x0d, 0x87],\n        [0x0e, 0x41],\n        [0x4c, 0x00],\n        [0xff, 0x00],\n        [0xe0, 0x04],\n        [0xc0, 0x64],\n        [0xc1, 0x4b],\n        [0x86, 0x35],\n        [0x50, 0x92],\n        [0x51, 0xc8],\n        [0x52, 0x96],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x00],\n        [0x57, 0x00],\n        [0x5a, 0x2c],\n        [0x5b, 0x24],\n        [0x5c, 0x00],\n        [0xe0, 0x00],\n        [0xff, 0xff],\n      ],\n\n      OV2640_320x240_JPEG: [\n        [0xff, 0x01],\n        [0x12, 0x40],\n        [0x17, 0x11],\n        [0x18, 0x43],\n        [0x19, 0x00],\n        [0x1a, 0x4b],\n        [0x32, 0x09],\n        [0x4f, 0xca],\n        [0x50, 0xa8],\n        [0x5a, 0x23],\n        [0x6d, 0x00],\n        [0x39, 0x12],\n        [0x35, 0xda],\n        [0x22, 0x1a],\n        [0x37, 0xc3],\n        [0x23, 0x00],\n        [0x34, 0xc0],\n        [0x36, 0x1a],\n        [0x06, 0x88],\n        [0x07, 0xc0],\n        [0x0d, 0x87],\n        [0x0e, 0x41],\n        [0x4c, 0x00],\n        [0xff, 0x00],\n        [0xe0, 0x04],\n        [0xc0, 0x64],\n        [0xc1, 0x4b],\n        [0x86, 0x35],\n        [0x50, 0x89],\n        [0x51, 0xc8],\n        [0x52, 0x96],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x00],\n        [0x57, 0x00],\n        [0x5a, 0x50],\n        [0x5b, 0x3c],\n        [0x5c, 0x00],\n        [0xe0, 0x00],\n        [0xff, 0xff],\n      ],\n\n      OV2640_352x288_JPEG: [\n        [0xff, 0x01],\n        [0x12, 0x40],\n        [0x17, 0x11],\n        [0x18, 0x43],\n        [0x19, 0x00],\n        [0x1a, 0x4b],\n        [0x32, 0x09],\n        [0x4f, 0xca],\n        [0x50, 0xa8],\n        [0x5a, 0x23],\n        [0x6d, 0x00],\n        [0x39, 0x12],\n        [0x35, 0xda],\n        [0x22, 0x1a],\n        [0x37, 0xc3],\n        [0x23, 0x00],\n        [0x34, 0xc0],\n        [0x36, 0x1a],\n        [0x06, 0x88],\n        [0x07, 0xc0],\n        [0x0d, 0x87],\n        [0x0e, 0x41],\n        [0x4c, 0x00],\n        [0xff, 0x00],\n        [0xe0, 0x04],\n        [0xc0, 0x64],\n        [0xc1, 0x4b],\n        [0x86, 0x35],\n        [0x50, 0x89],\n        [0x51, 0xc8],\n        [0x52, 0x96],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x00],\n        [0x57, 0x00],\n        [0x5a, 0x58],\n        [0x5b, 0x48],\n        [0x5c, 0x00],\n        [0xe0, 0x00],\n        [0xff, 0xff],\n      ],\n\n      OV2640_640x480_JPEG: [\n        [0xff, 0x01],\n        [0x11, 0x01],\n        [0x12, 0x00], // Bit[6:4]: Resolution selection//\n        [0x17, 0x11], // HREFST[10:3]\n        [0x18, 0x75], // HREFEND[10:3]\n        [0x32, 0x36], // Bit[5:3]: HREFEND[2:0]; Bit[2:0]: HREFST[2:0]\n        [0x19, 0x01], // VSTRT[9:2]\n        [0x1a, 0x97], // VEND[9:2]\n        [0x03, 0x0f], // Bit[3:2]: VEND[1:0]; Bit[1:0]: VSTRT[1:0]\n        [0x37, 0x40],\n        [0x4f, 0xbb],\n        [0x50, 0x9c],\n        [0x5a, 0x57],\n        [0x6d, 0x80],\n        [0x3d, 0x34],\n        [0x39, 0x02],\n        [0x35, 0x88],\n        [0x22, 0x0a],\n        [0x37, 0x40],\n        [0x34, 0xa0],\n        [0x06, 0x02],\n        [0x0d, 0xb7],\n        [0x0e, 0x01],\n\n        [0xff, 0x00],\n        [0xe0, 0x04],\n        [0xc0, 0xc8],\n        [0xc1, 0x96],\n        [0x86, 0x3d],\n        [0x50, 0x89],\n        [0x51, 0x90],\n        [0x52, 0x2c],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x88],\n        [0x57, 0x00],\n        [0x5a, 0xa0],\n        [0x5b, 0x78],\n        [0x5c, 0x00],\n        [0xd3, 0x04],\n        [0xe0, 0x00],\n        [0xff, 0xff],\n      ],\n\n      OV2640_800x600_JPEG: [\n        [0xff, 0x01],\n        [0x11, 0x01],\n        [0x12, 0x00], // Bit[6:4]: Resolution selection\n        [0x17, 0x11], // HREFST[10:3]\n        [0x18, 0x75], // HREFEND[10:3]\n        [0x32, 0x36], // Bit[5:3]: HREFEND[2:0]; Bit[2:0]: HREFST[2:0]\n        [0x19, 0x01], // VSTRT[9:2]\n        [0x1a, 0x97], // VEND[9:2]\n        [0x03, 0x0f], // Bit[3:2]: VEND[1:0]; Bit[1:0]: VSTRT[1:0]\n        [0x37, 0x40],\n        [0x4f, 0xbb],\n        [0x50, 0x9c],\n        [0x5a, 0x57],\n        [0x6d, 0x80],\n        [0x3d, 0x34],\n        [0x39, 0x02],\n        [0x35, 0x88],\n        [0x22, 0x0a],\n        [0x37, 0x40],\n        [0x34, 0xa0],\n        [0x06, 0x02],\n        [0x0d, 0xb7],\n        [0x0e, 0x01],\n\n        [0xff, 0x00],\n        [0xe0, 0x04],\n        [0xc0, 0xc8],\n        [0xc1, 0x96],\n        [0x86, 0x35],\n        [0x50, 0x89],\n        [0x51, 0x90],\n        [0x52, 0x2c],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x88],\n        [0x57, 0x00],\n        [0x5a, 0xc8],\n        [0x5b, 0x96],\n        [0x5c, 0x00],\n        [0xd3, 0x02],\n        [0xe0, 0x00],\n\n        [0xff, 0xff],\n      ],\n\n      OV2640_1024x768_JPEG: [\n        [0xff, 0x01],\n        [0x11, 0x01],\n        [0x12, 0x00], // Bit[6:4]: Resolution selection//0x02\n        [0x17, 0x11], // HREFST[10:3]\n        [0x18, 0x75], // HREFEND[10:3]\n        [0x32, 0x36], // Bit[5:3]: HREFEND[2:0]; Bit[2:0]: HREFST[2:0]\n        [0x19, 0x01], // VSTRT[9:2]\n        [0x1a, 0x97], // VEND[9:2]\n        [0x03, 0x0f], // Bit[3:2]: VEND[1:0]; Bit[1:0]: VSTRT[1:0]\n        [0x37, 0x40],\n        [0x4f, 0xbb],\n        [0x50, 0x9c],\n        [0x5a, 0x57],\n        [0x6d, 0x80],\n        [0x3d, 0x34],\n        [0x39, 0x02],\n        [0x35, 0x88],\n        [0x22, 0x0a],\n        [0x37, 0x40],\n        [0x34, 0xa0],\n        [0x06, 0x02],\n        [0x0d, 0xb7],\n        [0x0e, 0x01],\n\n        [0xff, 0x00],\n        [0xc0, 0xc8],\n        [0xc1, 0x96],\n        [0x8c, 0x00],\n        [0x86, 0x3d],\n        [0x50, 0x00],\n        [0x51, 0x90],\n        [0x52, 0x2c],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x88],\n        [0x5a, 0x00],\n        [0x5b, 0xc0],\n        [0x5c, 0x01],\n        [0xd3, 0x02],\n\n        [0xff, 0xff],\n      ],\n\n      OV2640_1280x960_JPEG: [\n        [0xff, 0x01],\n        [0x11, 0x01],\n        [0x12, 0x00], // Bit[6:4]: Resolution selection//0x02\n        [0x17, 0x11], // HREFST[10:3]\n        [0x18, 0x75], // HREFEND[10:3]\n        [0x32, 0x36], // Bit[5:3]: HREFEND[2:0]; Bit[2:0]: HREFST[2:0]\n        [0x19, 0x01], // VSTRT[9:2]\n        [0x1a, 0x97], // VEND[9:2]\n        [0x03, 0x0f], // Bit[3:2]: VEND[1:0]; Bit[1:0]: VSTRT[1:0]\n        [0x37, 0x40],\n        [0x4f, 0xbb],\n        [0x50, 0x9c],\n        [0x5a, 0x57],\n        [0x6d, 0x80],\n        [0x3d, 0x34],\n        [0x39, 0x02],\n        [0x35, 0x88],\n        [0x22, 0x0a],\n        [0x37, 0x40],\n        [0x34, 0xa0],\n        [0x06, 0x02],\n        [0x0d, 0xb7],\n        [0x0e, 0x01],\n\n        [0xff, 0x00],\n        [0xe0, 0x04],\n        [0xc0, 0xc8],\n        [0xc1, 0x96],\n        [0x86, 0x3d],\n        [0x50, 0x00],\n        [0x51, 0x90],\n        [0x52, 0x2c],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x88],\n        [0x57, 0x00],\n        [0x5a, 0x40],\n        [0x5b, 0xf0],\n        [0x5c, 0x01],\n        [0xd3, 0x02],\n        [0xe0, 0x00],\n\n        [0xff, 0xff],\n      ],\n\n      OV2640_1600x1200_JPEG: [\n        [0xff, 0x01],\n        [0x11, 0x01],\n        [0x12, 0x00], // Bit[6:4]: Resolution selection//0x02\n        [0x17, 0x11], // HREFST[10:3]\n        [0x18, 0x75], // HREFEND[10:3]\n        [0x32, 0x36], // Bit[5:3]: HREFEND[2:0]; Bit[2:0]: HREFST[2:0]\n        [0x19, 0x01], // VSTRT[9:2]\n        [0x1a, 0x97], // VEND[9:2]\n        [0x03, 0x0f], // Bit[3:2]: VEND[1:0]; Bit[1:0]: VSTRT[1:0]\n        [0x37, 0x40],\n        [0x4f, 0xbb],\n        [0x50, 0x9c],\n        [0x5a, 0x57],\n        [0x6d, 0x80],\n        [0x3d, 0x34],\n        [0x39, 0x02],\n        [0x35, 0x88],\n        [0x22, 0x0a],\n        [0x37, 0x40],\n        [0x34, 0xa0],\n        [0x06, 0x02],\n        [0x0d, 0xb7],\n        [0x0e, 0x01],\n\n        [0xff, 0x00],\n        [0xe0, 0x04],\n        [0xc0, 0xc8],\n        [0xc1, 0x96],\n        [0x86, 0x3d],\n        [0x50, 0x00],\n        [0x51, 0x90],\n        [0x52, 0x2c],\n        [0x53, 0x00],\n        [0x54, 0x00],\n        [0x55, 0x88],\n        [0x57, 0x00],\n        [0x5a, 0x90],\n        [0x5b, 0x2c],\n        [0x5c, 0x05], // bit2->1;bit[1:0]->1\n        [0xd3, 0x02],\n        [0xe0, 0x00],\n\n        [0xff, 0xff],\n      ],\n    };\n  }\n\n  public wired(obniz: Obniz) {\n    this.obniz.setVccGnd(this.params.vcc, this.params.gnd, \"5v\");\n\n    this.io_cs = obniz.getIO(this.params.cs);\n    this.io_cs.output(true);\n\n    obniz.wait(100);\n\n    this.sensor_addr = 0x30; // i2c\n\n    this.params.module_version = this.params.module_version || 0;\n    this.params.mode = this.params.mode || \"master\";\n    this.params.drive = this.params.spi_drive || \"3v\";\n    this.params.frequency = this.params.spi_frequency || 4 * 1000 * 1000;\n    this.params.clk = this.params.sclk;\n    this.spi = this.obniz.getSpiWithConfig(this.params);\n\n    this.params.sda = this.params.sda;\n    this.params.scl = this.params.scl;\n    this.params.clock = this.params.clock || 100 * 1000;\n    this.params.mode = \"master\";\n    this.params.pull = \"5v\";\n    this.i2c = obniz.getI2CWithConfig(this.params);\n  }\n\n  public spi_write(addr: number, byteData: number) {\n    const data = [];\n    data.push(addr);\n    data.push(byteData);\n    this.io_cs.output(false);\n    this.spi.write(data);\n    this.io_cs.output(true);\n  }\n\n  public async spi_readWait(addr: number) {\n    const data = [];\n    data.push(addr);\n    data.push(0x00);\n    this.io_cs.output(false);\n    const recv = await this.spi.writeWait(data);\n    this.io_cs.output(true);\n    return recv[1];\n  }\n\n  public i2c_byte_write(addr: number, byteData: number) {\n    this.i2c.write(this.sensor_addr, [addr, byteData]);\n  }\n\n  public i2c_regs_write(regs: number[]) {\n    for (let i = 0; i < regs.length; i++) {\n      this.i2c.write(this.sensor_addr, regs[i]);\n    }\n  }\n\n  public spi_write_reg(addr: number, byteData: number) {\n    this.spi_write(addr | 0x80, byteData);\n  }\n\n  public async spi_read_regWait(addr: number) {\n    return await this.spi_readWait(addr & 0x7f);\n  }\n\n  public async spi_pingpongWait() {\n    const testVal = 0x55;\n    this.spi_write_reg(this.regs.ARDUCHIP_TEST1, testVal);\n    const val = await this.spi_read_regWait(this.regs.ARDUCHIP_TEST1);\n    if (val !== testVal) {\n      throw new Error(\"spi bus fail\");\n    }\n  }\n\n  public setMode(mode: string) {\n    const modes: any = {\n      MCU2LCD: 0x00,\n      CAM2LCD: 0x01,\n      LCD2MCU: 0x02,\n    };\n    if (typeof modes[mode] !== \"number\") {\n      throw new Error(\"unknown mode. options are \" + modes);\n    }\n    this.spi_write_reg(this.regs.ARDUCHIP_MODE, modes[mode]);\n  }\n\n  public async getChipIdWait(): Promise<number> {\n    this.i2c.write(this.sensor_addr, [0x0a]);\n    const val0: number[] = await this.i2c.readWait(this.sensor_addr, 1);\n    this.i2c.write(this.sensor_addr, [0x0b]);\n    const val1: number[] = await this.i2c.readWait(this.sensor_addr, 1);\n    return (val0[0] << 8) + val1[0];\n  }\n\n  public init() {\n    this.i2c_byte_write(0xff, 0x01);\n    this.i2c_byte_write(0x12, 0x80);\n    this.obniz.wait(100);\n\n    this.i2c_regs_write(this.configs.OV2640_JPEG_INIT);\n    this.i2c_regs_write(this.configs.OV2640_YUV422);\n    this.i2c_regs_write(this.configs.OV2640_JPEG);\n    this.i2c_byte_write(0xff, 0x01);\n    this.i2c_byte_write(0x15, 0x00);\n    this.setSize(\"320x240\");\n  }\n\n  public async startupWait() {\n    await this.spi_pingpongWait();\n    this.setMode(\"MCU2LCD\");\n    const chipid = await this.getChipIdWait();\n    if (chipid !== 0x2642 && chipid !== 0x2641) {\n      throw new Error(\"unknown chip \" + chipid);\n    }\n    this.init();\n  }\n\n  public async takeWait(size: number): Promise<number[]> {\n    if (typeof size === \"string\" && this._size !== size) {\n      this.setSize(size);\n      this.obniz.wait(1000);\n    }\n\n    this.flushFIFO();\n    this.flushFIFO();\n    this.startCapture();\n    while (true) {\n      if (await this.isCaptureDoneWait()) {\n        break;\n      }\n    }\n    return await this.readFIFOWait();\n  }\n\n  public setSize(string: string) {\n    if (this._size === string) {\n      return;\n    }\n    const map: any = {\n      \"160x120\": this.configs.OV2640_160x120_JPEG,\n      \"176x144\": this.configs.OV2640_176x144_JPEG,\n      \"320x240\": this.configs.OV2640_320x240_JPEG,\n      \"352x288\": this.configs.OV2640_352x288_JPEG,\n      \"640x480\": this.configs.OV2640_640x480_JPEG,\n      \"800x600\": this.configs.OV2640_800x600_JPEG,\n      \"1024x768\": this.configs.OV2640_1024x768_JPEG,\n      \"1280x960\": this.configs.OV2640_1280x960_JPEG,\n      \"1600x1200\": this.configs.OV2640_1600x1200_JPEG,\n    };\n    if (map[string]) {\n      this._size = string;\n      this.i2c_regs_write(map[string]);\n    } else {\n      throw new Error(\"unsupported size options are \" + Object.keys(map));\n    }\n  }\n\n  public updateFIFO(data: any) {\n    //  FIFO_CLEAR_MASK    \t\t0x01\n    //  FIFO_START_MASK    \t\t0x02\n    //  FIFO_RDPTR_RST_MASK     0x10\n    //  FIFO_WRPTR_RST_MASK     0x20\n    this.spi_write_reg(this.regs.ARDUCHIP_FIFO, data);\n  }\n\n  public flushFIFO() {\n    this.spi_write_reg(this.regs.ARDUCHIP_FIFO, 0x01);\n  }\n\n  public async readFIFOLengthWait(): Promise<number> {\n    const len1 = await this.spi_read_regWait(this.regs.FIFO_SIZE1);\n    const len2 = await this.spi_read_regWait(this.regs.FIFO_SIZE2);\n    const len3 = (await this.spi_read_regWait(this.regs.FIFO_SIZE3)) & 0x07;\n    return ((len3 << 16) | (len2 << 8) | len1) & 0x07ffff;\n  }\n\n  public startCapture() {\n    this.spi_write_reg(this.regs.ARDUCHIP_FIFO, 0x02);\n  }\n\n  public async isCaptureDoneWait(): Promise<boolean> {\n    const CAP_DONE_MASK = 0x08;\n    const val = await this.spi_read_regWait(this.regs.ARDUCHIP_TRIG);\n    return val & CAP_DONE_MASK ? true : false;\n  }\n\n  public async readFIFOWait(): Promise<number[]> {\n    // get length of image data\n    const length = await this.readFIFOLengthWait();\n\n    // start bust\n    this.io_cs.output(false);\n    this.spi.write([this.regs.BURST_FIFO_READ]);\n\n    if (this.params.module_version === 0) {\n      this.spi.write([0xff]); // dummy read\n    }\n\n    const buf = [];\n\n    while (buf.length < length) {\n      let mustRead: number = length - buf.length;\n      if (mustRead > 1024) {\n        mustRead = 1024;\n      }\n      const arr = new Array(mustRead);\n      arr.fill(0);\n      const sliced = await this.spi.writeWait(arr);\n      buf.push(...sliced);\n    }\n    // end burst\n    this.io_cs.output(true);\n\n    return buf;\n  }\n\n  public arrayToBase64(array: number[]): string {\n    return Buffer.from(array).toString(\"base64\");\n  }\n}\n"]}