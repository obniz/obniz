{"version":3,"sources":["../src/parts/Light/WS2811/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import Obniz from \"../../../obniz\";\r\nimport PeripheralSPI from \"../../../obniz/libs/io_peripherals/spi\";\r\nimport ObnizPartsInterface, {ObnizPartsInfo} from \"../../../obniz/ObnizPartsInterface\";\r\n\r\nexport interface WS2811Options {\r\n  gnd?: number;\r\n  vcc?: number;\r\n  din: number;\r\n}\r\n\r\nexport default class WS2811 implements ObnizPartsInterface {\r\n\r\n  public static info(): ObnizPartsInfo {\r\n    return {\r\n      name: \"WS2811\",\r\n    };\r\n  }\r\n\r\n  private static _generateFromByte(val: any) {\r\n    // T0H 0.5us+-0.15us\r\n    // T1H 1.2us+-0.15us\r\n    // T0L 2.0us+-0.15us\r\n    // T1L 1.3us+-0.15us\r\n\r\n    val = parseInt(val);\r\n    const zero: any = 0x8;\r\n    const one: any = 0xe;\r\n    const ret: any = [];\r\n    for (let i = 0; i < 8; i += 2) {\r\n      let byte: any = 0;\r\n      if (val & (0x80 >> i)) {\r\n        byte = one << 4;\r\n      } else {\r\n        byte = zero << 4;\r\n      }\r\n      if (val & (0x80 >> (i + 1))) {\r\n        byte |= one;\r\n      } else {\r\n        byte |= zero;\r\n      }\r\n      ret.push(byte);\r\n    }\r\n    return ret;\r\n  }\r\n\r\n  private static _generateColor(r: number, g: number, b: number) {\r\n    let array = WS2811._generateFromByte(r);\r\n    array = array.concat(WS2811._generateFromByte(g));\r\n    array = array.concat(WS2811._generateFromByte(b));\r\n    return array;\r\n  }\r\n\r\n  private static _generateHsvColor(h: number, s: number, v: number) {\r\n    const C = v * s;\r\n    const Hp = h / 60;\r\n    const X = C * (1 - Math.abs((Hp % 2) - 1));\r\n\r\n    let R: any;\r\n    let G: any;\r\n    let B: any;\r\n    if (0 <= Hp && Hp < 1) {\r\n      [R, G, B] = [C, X, 0];\r\n    }\r\n    if (1 <= Hp && Hp < 2) {\r\n      [R, G, B] = [X, C, 0];\r\n    }\r\n    if (2 <= Hp && Hp < 3) {\r\n      [R, G, B] = [0, C, X];\r\n    }\r\n    if (3 <= Hp && Hp < 4) {\r\n      [R, G, B] = [0, X, C];\r\n    }\r\n    if (4 <= Hp && Hp < 5) {\r\n      [R, G, B] = [X, 0, C];\r\n    }\r\n    if (5 <= Hp && Hp < 6) {\r\n      [R, G, B] = [C, 0, X];\r\n    }\r\n\r\n    const m: any = v - C;\r\n    [R, G, B] = [R + m, G + m, B + m];\r\n\r\n    R = Math.floor(R * 255);\r\n    G = Math.floor(G * 255);\r\n    B = Math.floor(B * 255);\r\n\r\n    let array: any = WS2811._generateFromByte(R);\r\n    array = array.concat(WS2811._generateFromByte(G));\r\n    array = array.concat(WS2811._generateFromByte(B));\r\n    return array;\r\n  }\r\n\r\n  public keys: string[];\r\n  public requiredKeys: string[];\r\n  public params: any;\r\n\r\n  public spi!: PeripheralSPI;\r\n\r\n  protected obniz!: Obniz;\r\n\r\n  constructor() {\r\n    this.keys = [\"din\", \"vcc\", \"gnd\"];\r\n    this.requiredKeys = [\"din\"];\r\n  }\r\n\r\n  public wired(obniz: Obniz) {\r\n    this.obniz = obniz;\r\n\r\n    obniz.setVccGnd(this.params.vcc, this.params.gnd, \"5v\");\r\n\r\n    this.params.mode = \"master\";\r\n    this.params.frequency = 2 * 1000 * 1000;\r\n    this.params.mosi = this.params.din;\r\n    this.params.drive = \"5v\"; // It over spec for frequency. But VIN-HI require 0.7VCC<=.\r\n    this.spi = this.obniz.getSpiWithConfig(this.params);\r\n  }\r\n\r\n  public rgb(red: number, green: number, blue: number) {\r\n    this.spi.write(WS2811._generateColor(red, green, blue));\r\n  }\r\n\r\n  public hsv(hue: number, saturation: number, value: number) {\r\n    this.spi.write(WS2811._generateHsvColor(hue, saturation, value));\r\n  }\r\n\r\n  public rgbs(array: Array<[number, number, number]>) {\r\n    let bytes: number[] = [];\r\n    for (let i = 0; i < array.length; i++) {\r\n      const oneArray: number[] = array[i];\r\n      bytes = bytes.concat(\r\n        WS2811._generateColor(oneArray[0], oneArray[1], oneArray[2]),\r\n      );\r\n    }\r\n    this.spi.write(bytes);\r\n  }\r\n\r\n  public hsvs(array: Array<[number, number, number]>) {\r\n    let bytes: number[] = [];\r\n    for (let i = 0; i < array.length; i++) {\r\n      const oneArray = array[i];\r\n      bytes = bytes.concat(\r\n        WS2811._generateHsvColor(oneArray[0], oneArray[1], oneArray[2]),\r\n      );\r\n    }\r\n    this.spi.write(bytes);\r\n  }\r\n\r\n}\r\n"]}