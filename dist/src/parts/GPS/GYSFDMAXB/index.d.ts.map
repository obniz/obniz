{"version":3,"sources":["../src/parts/GPS/GYSFDMAXB/index.ts"],"names":[],"mappings":"AAAA,OAAO,KAAK,MAAM,gBAAgB,CAAC;AAEnC,OAAO,mBAAmB,EAAE,EAAC,cAAc,EAAC,MAAM,oCAAoC,CAAC;AAEvF,MAAM,WAAW,gBAAgB;IAC/B,GAAG,CAAC,EAAE,MAAM,CAAC;IACb,GAAG,CAAC,EAAE,MAAM,CAAC;IACb,GAAG,EAAE,MAAM,CAAC;IACZ,GAAG,EAAE,MAAM,CAAC;IACZ,IAAI,CAAC,EAAE,MAAM,CAAC;CACf;AAED,MAAM,WAAW,mBAAmB;IAClC,MAAM,EAAE,OAAO,CAAC;IAChB,KAAK,EAAE,MAAM,CAAC;IACd,KAAK,EAAE,MAAM,CAAC;IACd,KAAK,EAAE,MAAM,CAAC;IACd,KAAK,EAAE,GAAG,EAAE,CAAC;IACb,KAAK,EAAE,MAAM,CAAC;IACd,KAAK,EAAE,MAAM,CAAC;IACd,KAAK,EAAE,MAAM,CAAC;IACd,CAAC,GAAG,EAAE,MAAM,GAAG,GAAG,CAAC;IACnB,SAAS,EAAE,IAAI,CAAC;CACjB;AAED,MAAM,CAAC,OAAO,OAAO,SAAU,YAAW,mBAAmB;IAE3D,IAAI,QAAQ,WAEX;IAED,IAAI,SAAS,WAEZ;WAEa,IAAI,IAAI,cAAc;IAM7B,IAAI,EAAE,MAAM,EAAE,CAAC;IACf,YAAY,EAAE,MAAM,EAAE,CAAC;IACvB,MAAM,EAAE,MAAM,EAAE,CAAC;IACjB,WAAW,SAAS;IACpB,cAAc;;;;MAA0C;IACxD,MAAM,EAAE,GAAG,CAAC;IAEZ,UAAU,EAAE,GAAG,CAAC;IAChB,MAAM,EAAE,CAAC,MAAM,IAAI,CAAC,GAAG,IAAI,CAAQ;IACnC,QAAQ,SAAK;IACb,OAAO,EAAE,GAAG,CAAC;IACb,MAAM,EAAE,GAAG,CAAC;IACZ,OAAO,EAAE,GAAG,CAAC;IACb,UAAU,EAAE,GAAG,CAAC;IAEvB,SAAS,CAAC,KAAK,EAAG,KAAK,CAAC;IAExB,OAAO,CAAC,EAAE,CAAU;IACpB,OAAO,CAAC,EAAE,CAAU;IACpB,OAAO,CAAC,GAAG,CAAU;IACrB,OAAO,CAAC,GAAG,CAAU;IACrB,OAAO,CAAC,IAAI,CAAU;IACtB,OAAO,CAAC,IAAI,CAAkB;IAE9B,OAAO,CAAC,SAAS,CAAM;IACvB,OAAO,CAAC,UAAU,CAAM;;IASjB,KAAK,CAAC,KAAK,EAAE,KAAK;IAyClB,SAAS,CAAC,QAAQ,EAAE,CAAC,MAAM,IAAI,CAAC,GAAG,IAAI;IAkBvC,YAAY,IAAI,GAAG;IAanB,aAAa,IAAI,mBAAmB;IAoEpC,UAAU,CAAC,UAAU,CAAC,EAAE,mBAAmB,GAAG,GAAG;IAqGjD,OAAO,CAAC,MAAM,EAAE,GAAG,EAAE,KAAK,EAAE,GAAG;IAmB/B,UAAU,CAAC,MAAM,EAAE,GAAG;IAItB,WAAW,CAAC,MAAM,EAAE,GAAG;IAIvB,aAAa,CAAC,MAAM,EAAE,GAAG;IAWzB,cAAc,CAAC,OAAO,EAAE,GAAG;IAc3B,iBAAiB,CAAC,UAAU,EAAE,GAAG;IAejC,QAAQ,CAAC,GAAG,EAAE,GAAG,GAAG,MAAM;IAS1B,OAAO,CAAC,GAAG,EAAE,GAAG,GAAG,MAAM;IAQzB,OAAO,CAAC,GAAG,EAAE,GAAG,GAAG,MAAM;IASzB,MAAM,CAAC,GAAG,EAAE,GAAG,GAAG,MAAM;CAQhC","file":"index.d.ts","sourcesContent":["import Obniz from \"../../../obniz\";\r\nimport PeripheralUART from \"../../../obniz/libs/io_peripherals/uart\";\r\nimport ObnizPartsInterface, {ObnizPartsInfo} from \"../../../obniz/ObnizPartsInterface\";\r\n\r\nexport interface GYSFDMAXBOptions {\r\n  vcc?: number;\r\n  gnd?: number;\r\n  txd: number;\r\n  rxd: number;\r\n  Opps?: number;\r\n}\r\n\r\nexport interface GYSFDMAXBEditedData {\r\n  enable: boolean;\r\n  GPGGA: number;\r\n  GPGLL: number;\r\n  GPGSA: number;\r\n  GPGSV: any[];\r\n  GPRMC: number;\r\n  GPVTG: number;\r\n  GPZDA: number;\r\n  [key: string]: any;\r\n  timestamp: Date;\r\n}\r\n\r\nexport default class GYSFDMAXB implements ObnizPartsInterface {\r\n  // -------------------\r\n  get latitude() {\r\n    return this.nmea2dd(this._latitude);\r\n  }\r\n\r\n  get longitude() {\r\n    return this.nmea2dd(this._longitude);\r\n  }\r\n\r\n  public static info(): ObnizPartsInfo {\r\n    return {\r\n      name: \"GYSFDMAXB\",\r\n    };\r\n  }\r\n\r\n  public keys: string[];\r\n  public requiredKeys: string[];\r\n  public ioKeys: string[];\r\n  public displayName = \"gps\";\r\n  public displayIoNames = {txd: \"txd\", rxd: \"rxd\", Opps: \"1pps\"};\r\n  public params: any;\r\n\r\n  public editedData: any;\r\n  public on1pps: (() => void) | null = null;\r\n  public last1pps = 0;\r\n  public gpsInfo: any;\r\n  public status: any;\r\n  public fixMode: any;\r\n  public gpsQuality: any;\r\n\r\n  protected obniz!: Obniz;\r\n\r\n  private tx!: number;\r\n  private rx!: number;\r\n  private vcc!: number;\r\n  private gnd!: number;\r\n  private Opps!: number;\r\n  private uart!: PeripheralUART;\r\n\r\n  private _latitude: any;\r\n  private _longitude: any;\r\n\r\n  constructor() {\r\n    this.keys = [\"vcc\", \"txd\", \"rxd\", \"gnd\", \"Opps\"];\r\n    this.requiredKeys = [\"txd\", \"rxd\"];\r\n\r\n    this.ioKeys = this.keys;\r\n  }\r\n\r\n  public wired(obniz: Obniz) {\r\n    this.obniz = obniz;\r\n    this.tx = this.params.txd;\r\n    this.rx = this.params.rxd;\r\n    this.vcc = this.params.vcc;\r\n    this.gnd = this.params.gnd;\r\n    this.Opps = this.params.Opps;\r\n\r\n    this.obniz.setVccGnd(this.params.vcc, this.params.gnd, \"5v\");\r\n    this.uart = obniz.getFreeUart();\r\n    this.uart.start({\r\n      tx: this.params.txd,\r\n      rx: this.params.rxd,\r\n      baud: 9600,\r\n      drive: \"3v\",\r\n    });\r\n\r\n    this.editedData = {};\r\n    this.editedData.enable = false;\r\n    this.editedData.GPGSV = new Array(4);\r\n\r\n    this.on1pps = null;\r\n    this.last1pps = 0;\r\n\r\n    this.gpsInfo = {};\r\n    this.gpsInfo._sentenceType = {\r\n      GPGGA: 0x0001, // GGA - Global Positioning System Fix Data\r\n      GPGSA: 0x0002, // GSA - GNSS DOP and active satellites\r\n      GPGSV: 0x0004, // GSV - Satellites in view\r\n      GPRMC: 0x0008, // RMC - Recommended minimum specific GNSS data\r\n      GPVTG: 0x0010, // VTG - Track made good and ground speed\r\n      GPZDA: 0x0020, // ZDA - Date & Time\r\n    };\r\n    this.gpsInfo.status = \"V\";\r\n    this.gpsInfo.sentences = new Set(); // Set specifying sentence of MNEA from which data have been obtained\r\n    this.gpsInfo.satelliteInfo = {\r\n      satellites: [],\r\n      inView: 0,\r\n    };\r\n  }\r\n\r\n  public start1pps(callback: (() => void) | null) {\r\n    this.on1pps = callback;\r\n    if (callback) {\r\n      this.last1pps = 2;\r\n      this.obniz.getAD(this.Opps).start((voltage: number) => {\r\n        const vol: any = Math.round(voltage);\r\n        if (vol !== this.last1pps) {\r\n          this.last1pps = vol;\r\n          if (vol === 0 && this.on1pps) {\r\n            this.on1pps();\r\n          }\r\n        }\r\n      });\r\n    } else {\r\n      this.obniz.getAD(this.Opps).end();\r\n    }\r\n  }\r\n\r\n  public readSentence(): any {\r\n    let results: any = [];\r\n    if (this.uart.isDataExists()) {\r\n      const pos: any = this.uart.received.indexOf(0x0a);\r\n      if (pos >= 0) {\r\n        results = this.uart.received.slice(0, pos - 1);\r\n        this.uart.received.splice(0, pos + 1);\r\n        return this.uart.tryConvertString(results);\r\n      }\r\n    }\r\n    return \"\";\r\n  }\r\n\r\n  public getEditedData(): GYSFDMAXBEditedData {\r\n    let n: any;\r\n    let utc: any;\r\n    let format: any;\r\n    let sentence: any = this.readSentence();\r\n    this.editedData.enable = false;\r\n    this.editedData.GPGSV = new Array(4);\r\n    while (sentence.length > 0) {\r\n      const part: any = sentence.split(\",\");\r\n      if (sentence.slice(-4, -3) !== \",\") {\r\n        const st: any = part[part.length - 1].slice(0, -3);\r\n        part.push(part[part.length - 1].slice(-3));\r\n        part[part.length - 2] = st;\r\n      }\r\n      this.editedData.sentence = part.join(\",\");\r\n      switch (part[0]) {\r\n        case \"$GPGGA\":\r\n          this.editedData.GPGGA = part;\r\n          break;\r\n        case \"$GPGLL\":\r\n          this.editedData.GPGLL = part;\r\n          break;\r\n        case \"$GPGSA\":\r\n          this.editedData.GPGSA = part;\r\n          break;\r\n        case \"$GPGSV\":\r\n          n = Number(part[2]);\r\n          if (n > this.editedData.GPGSV.length) {\r\n            while (n > this.editedData.GPGSV.length) {\r\n              this.editedData.GPGSV.push([]);\r\n            }\r\n          }\r\n          this.editedData.GPGSV[n - 1] = part;\r\n          break;\r\n        case \"$GPRMC\":\r\n          this.editedData.GPRMC = part;\r\n          break;\r\n        case \"$GPVTG\":\r\n          this.editedData.GPVTG = part;\r\n          break;\r\n        case \"$GPZDA\":\r\n          this.editedData.GPZDA = part;\r\n          utc =\r\n            part[4] +\r\n            \"/\" +\r\n            part[3] +\r\n            \"/\" +\r\n            part[2] +\r\n            \" \" +\r\n            part[1].substring(0, 2) +\r\n            \":\" +\r\n            part[1].substring(2, 4) +\r\n            \":\" +\r\n            part[1].substring(4, 6) +\r\n            \" +00:00\";\r\n          this.editedData.timestamp = new Date(utc);\r\n          break;\r\n        default:\r\n          format = part[0].substr(1);\r\n          this.editedData[format] = part;\r\n      }\r\n\r\n      this.editedData.enable = true;\r\n      sentence = this.readSentence();\r\n    }\r\n    return this.editedData;\r\n  }\r\n\r\n  public getGpsInfo(editedData?: GYSFDMAXBEditedData): any {\r\n    const NMEA_SATINSENTENCE: any = 4;\r\n    const NMEA_MAXSAT: any = 12;\r\n    editedData = editedData || this.getEditedData();\r\n    this.gpsInfo.status = \"V\";\r\n    if (editedData.enable) {\r\n      if (editedData.GPGGA) {\r\n        const gga: any = editedData.GPGGA;\r\n        this.gpsInfo.gpsQuality = parseFloat(gga[6]); // Fix Quality: 0 = Invalid, 1 = GPS fix, 2 = DGPS fix\r\n        this.gpsInfo.hdop = parseFloat(gga[8]); // Horizontal Dilution of Precision (HDOP)\r\n        this.gpsInfo.altitude = parseFloat(gga[9]); // Antenna Altitude meters above mean sea level\r\n        const latitude: any = this.nmea2dd(parseFloat(gga[2]));\r\n        this.gpsInfo.latitude = gga[3] === \"N\" ? latitude : -latitude;\r\n        const longitude: any = this.nmea2dd(parseFloat(gga[4]));\r\n        this.gpsInfo.longitude = gga[5] === \"E\" ? longitude : -longitude;\r\n        this.gpsInfo.sentences.add(this.gpsInfo._sentenceType.GPGGA);\r\n      }\r\n      if (editedData.GPGSV) {\r\n        for (let n = 0; n < editedData.GPGSV.length; n++) {\r\n          if (editedData.GPGSV[n]) {\r\n            const gsv: any = editedData.GPGSV[n].map((v: any) => parseFloat(v));\r\n            const pack_count: any = gsv[1];\r\n            const pack_index: any = gsv[2];\r\n            const sat_count: any = gsv[3];\r\n            if (pack_index > pack_count) {\r\n              continue;\r\n            }\r\n\r\n            this.gpsInfo.satelliteInfo.inView = sat_count;\r\n            let nsat: any = (pack_index - 1) * NMEA_SATINSENTENCE;\r\n            nsat =\r\n              nsat + NMEA_SATINSENTENCE > sat_count\r\n                ? sat_count - nsat\r\n                : NMEA_SATINSENTENCE;\r\n\r\n            for (let isat = 0; isat < nsat; ++isat) {\r\n              const isi: any = (pack_index - 1) * NMEA_SATINSENTENCE + isat;\r\n              if (this.gpsInfo.satelliteInfo.satellites.length <= isi) {\r\n                this.gpsInfo.satelliteInfo.satellites.push({});\r\n              }\r\n              const isatn: any = isat * NMEA_SATINSENTENCE;\r\n              this.gpsInfo.satelliteInfo.satellites[isi] = {\r\n                id: gsv[isatn + 4], // SV PRN number\r\n                elevation: gsv[isatn + 5], // Elevation in degrees, 90 maximum\r\n                azimuth: gsv[isatn + 6], // Azimuth, degrees from true north, 000 to 359\r\n                snr: gsv[isatn + 7], // SNR, 00-99 dB (null when not tracking)\r\n                inUse: false,\r\n              };\r\n            }\r\n            this.gpsInfo.sentences.add(this.gpsInfo._sentenceType.GPGSV);\r\n          }\r\n        }\r\n      }\r\n      if (editedData.GPGSA) {\r\n        const gsa: any = editedData.GPGSA;\r\n        let nuse: any = 0;\r\n        this.gpsInfo.fixMode = parseFloat(gsa[2]); // Fix Mode: 1=Fix not available, 2=2D, 3=3D\r\n        this.gpsInfo.pdop = parseFloat(gsa[15]); // PDOP: Position Dilution of Precision\r\n        this.gpsInfo.hdop = parseFloat(gsa[16]); // HDOP: Horizontal Dilution of Precision\r\n        this.gpsInfo.vdop = parseFloat(gsa[17]); // VDOP: Vertical Dilution of Position\r\n        for (let i = 0; i < NMEA_MAXSAT; ++i) {\r\n          for (let j = 0; j < this.gpsInfo.satelliteInfo.inView; ++j) {\r\n            if (\r\n              this.gpsInfo.satelliteInfo.satellites[j] &&\r\n              gsa[i + 3] === this.gpsInfo.satelliteInfo.satellites[j].id\r\n            ) {\r\n              this.gpsInfo.satelliteInfo.satellites[j].inUse = true;\r\n              nuse++;\r\n            }\r\n          }\r\n        }\r\n        this.gpsInfo.satelliteInfo.inUse = nuse;\r\n        this.gpsInfo.sentences.add(this.gpsInfo._sentenceType.GPGSA);\r\n      }\r\n      if (editedData.GPRMC) {\r\n        const rmc: any = editedData.GPRMC;\r\n        this.gpsInfo.status = rmc[2]; // Status Active or Void\r\n        const latitude: any = this.nmea2dd(parseFloat(rmc[3]));\r\n        this.gpsInfo.latitude = rmc[4] === \"N\" ? latitude : -latitude;\r\n        const longitude: any = this.nmea2dd(parseFloat(rmc[5]));\r\n        this.gpsInfo.longitude = rmc[6] === \"E\" ? longitude : -longitude;\r\n        const NMEA_TUD_KNOTS: any = 1.852; // 1knot=1.852km/h\r\n        this.gpsInfo.speed = parseFloat(rmc[7]) * NMEA_TUD_KNOTS; // unit: km/h\r\n        this.gpsInfo.direction = rmc[8];\r\n        this.gpsInfo.sentences.add(this.gpsInfo._sentenceType.GPRMC);\r\n      }\r\n      if (editedData.GPVTG) {\r\n        const vtg: any = editedData.GPVTG;\r\n        this.gpsInfo.direction = parseFloat(vtg[1]);\r\n        this.gpsInfo.declination = parseFloat(vtg[3]);\r\n        this.gpsInfo.speed = parseFloat(vtg[7]);\r\n        this.gpsInfo.sentences.add(this.gpsInfo._sentenceType.GPVTG);\r\n      }\r\n      if (editedData.GPZDA) {\r\n        this.gpsInfo.utc = editedData.timestamp;\r\n        this.gpsInfo.sentences.add(this.gpsInfo._sentenceType.GPZDA);\r\n      }\r\n    }\r\n    return this.gpsInfo;\r\n  }\r\n\r\n  public _mneaTo(format: any, value: any) {\r\n    let result: any = this.nmea2dd(value);\r\n    if (typeof format === \"string\") {\r\n      switch (format.toUpperCase()) {\r\n        case \"DMS\":\r\n          result = this.nmea2dms(value);\r\n          break;\r\n        case \"DM\":\r\n          result = this.nmea2dm(value);\r\n          break;\r\n        case \"S\":\r\n          result = this.nmea2s(value);\r\n          break;\r\n        default:\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n  public latitudeTo(format: any) {\r\n    return this._mneaTo(format, this._latitude);\r\n  }\r\n\r\n  public longitudeTo(format: any) {\r\n    return this._mneaTo(format, this._longitude);\r\n  }\r\n\r\n  public status2string(status: any) {\r\n    status = status || this.status;\r\n    if (status === \"A\") {\r\n      return \"Active\";\r\n    }\r\n    if (status === \"V\") {\r\n      return \"Void\";\r\n    }\r\n    return status;\r\n  }\r\n\r\n  public fixMode2string(fixMode: any) {\r\n    fixMode = fixMode || this.fixMode;\r\n    if (fixMode === 1) {\r\n      return \"Fix not available\";\r\n    }\r\n    if (fixMode === 2) {\r\n      return \"2D\";\r\n    }\r\n    if (fixMode === 3) {\r\n      return \"3D\";\r\n    }\r\n    return fixMode;\r\n  }\r\n\r\n  public gpsQuality2string(gpsQuality: any) {\r\n    gpsQuality = gpsQuality || this.gpsQuality;\r\n    if (gpsQuality === 0) {\r\n      return \"Invalid\";\r\n    }\r\n    if (gpsQuality === 1) {\r\n      return \"GPS fix\";\r\n    }\r\n    if (gpsQuality === 2) {\r\n      return \"DGPS fix\";\r\n    }\r\n    return gpsQuality;\r\n  }\r\n\r\n  // --- latitude/longitude MNEA format change to each unit\r\n  public nmea2dms(val: any): string {\r\n    // NMEA format to DMS format string (999° 99'99.9\")\r\n    val = parseFloat(val);\r\n    const d: any = Math.floor(val / 100);\r\n    const m: any = Math.floor((val / 100.0 - d) * 100.0);\r\n    const s: any = ((val / 100.0 - d) * 100.0 - m) * 60;\r\n    return d + \"°\" + m + \"'\" + s.toFixed(1) + '\"';\r\n  }\r\n\r\n  public nmea2dm(val: any): string {\r\n    // NMEA format to DM format string (999° 99.9999')\r\n    val = parseFloat(val);\r\n    const d: any = Math.floor(val / 100.0);\r\n    const m: any = (val / 100.0 - d) * 100.0;\r\n    return d + \"°\" + m.toFixed(4) + \"'\";\r\n  }\r\n\r\n  public nmea2dd(val: any): number {\r\n    // NMEA format to DD format decimal (999.999999)\r\n    val = parseFloat(val);\r\n    const d: any = Math.floor(val / 100.0);\r\n    const m: any = Math.floor(((val / 100.0 - d) * 100.0) / 60);\r\n    const s: any = (((val / 100.0 - d) * 100.0 - m) * 60) / (60 * 60);\r\n    return parseFloat((d + m + s).toFixed(6));\r\n  }\r\n\r\n  public nmea2s(val: any): number {\r\n    // NMEA format to S format decimal (99999.9999)\r\n    val = parseFloat(val);\r\n    const d: any = Math.floor(val / 100.0);\r\n    const m: any = Math.floor(((val / 100.0 - d) * 100.0) / 60);\r\n    const s: any = (((val / 100.0 - d) * 100.0 - m) * 60) / (60 * 60);\r\n    return (d + m + s) / (1.0 / 60.0 / 60.0);\r\n  }\r\n}\r\n"]}