{"version":3,"sources":["../src/parts/Ble/2jcie/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import Obniz from \"../../../obniz\";\r\nimport bleRemoteCharacteristic from \"../../../obniz/libs/embeds/ble/bleRemoteCharacteristic\";\r\nimport bleRemotePeripheral from \"../../../obniz/libs/embeds/ble/bleRemotePeripheral\";\r\nimport ObnizPartsInterface, {ObnizPartsInfo} from \"../../../obniz/ObnizPartsInterface\";\r\n\r\nexport interface OMRON_2JCIEOptions {}\r\n\r\nexport interface OMRON_2JCIE_Data {\r\n  row_number: number;\r\n  temperature: number;\r\n  relative_humidity: number;\r\n  light: number;\r\n  uv_index: number;\r\n  barometric_pressure: number;\r\n  soud_noise: number;\r\n  discomfort_index: number;\r\n  heatstroke_risk_factor: number;\r\n  battery_voltage: number;\r\n}\r\n\r\nexport default class OMRON_2JCIE implements ObnizPartsInterface {\r\n\r\n  public static info(): ObnizPartsInfo {\r\n    return {\r\n      name: \"2JCIE\",\r\n    };\r\n  }\r\n\r\n  public keys: string[];\r\n  public requiredKeys: string[];\r\n  public periperal: bleRemotePeripheral | null;\r\n  public obniz!: Obniz;\r\n\r\n  constructor() {\r\n    this.keys = [];\r\n    this.requiredKeys = [];\r\n    this.periperal = null;\r\n  }\r\n\r\n  public wired(obniz: Obniz) {\r\n    this.obniz = obniz;\r\n  }\r\n\r\n  public async findWait(): Promise<any> {\r\n    const target: any = {\r\n      localName: \"Env\",\r\n    };\r\n\r\n    this.periperal = await this.obniz.ble!.scan.startOneWait(target);\r\n\r\n    return this.periperal;\r\n  }\r\n\r\n  public omron_uuid(uuid: string): string {\r\n    return `0C4C${uuid}-7700-46F4-AA96D5E974E32A54`;\r\n  }\r\n\r\n  public async connectWait(): Promise<void> {\r\n    if (!this.periperal) {\r\n      await this.findWait();\r\n    }\r\n    if (!this.periperal) {\r\n      throw new Error(\"2JCIE not found\");\r\n    }\r\n    if (!this.periperal.connected) {\r\n      await this.periperal.connectWait();\r\n    }\r\n  }\r\n\r\n  public async disconnectWait() {\r\n    if (this.periperal && this.periperal.connected) {\r\n      this.periperal.disconnectWait();\r\n    }\r\n  }\r\n\r\n  public signedNumberFromBinary(data: number[]) {\r\n    // little adian\r\n    let val: number = data[data.length - 1] & 0x7f;\r\n    for (let i = data.length - 2; i >= 0; i--) {\r\n      val = val * 256 + data[i];\r\n    }\r\n    if ((data[data.length - 1] & 0x80) !== 0) {\r\n      val = val - Math.pow(2, data.length * 8 - 1);\r\n    }\r\n    return val;\r\n  }\r\n\r\n  public unsignedNumberFromBinary(data: number[]) {\r\n    // little adian\r\n    let val: number = data[data.length - 1];\r\n    for (let i = data.length - 2; i >= 0; i--) {\r\n      val = val * 256 + data[i];\r\n    }\r\n    return val;\r\n  }\r\n\r\n  public async getLatestData(): Promise<OMRON_2JCIE_Data> {\r\n    await this.connectWait();\r\n\r\n    const c: bleRemoteCharacteristic = this.periperal!\r\n      .getService(this.omron_uuid(\"3000\"))\r\n      .getCharacteristic(this.omron_uuid(\"3001\"));\r\n    const data: number[] = await c.readWait();\r\n    const json: any = {\r\n      row_number: data[0],\r\n      temperature: this.signedNumberFromBinary(data.slice(1, 3)) * 0.01,\r\n      relative_humidity: this.signedNumberFromBinary(data.slice(3, 5)) * 0.01,\r\n      light: this.signedNumberFromBinary(data.slice(5, 7)) * 1,\r\n      uv_index: this.signedNumberFromBinary(data.slice(7, 9)) * 0.01,\r\n      barometric_pressure: this.signedNumberFromBinary(data.slice(9, 11)) * 0.1,\r\n      soud_noise: this.signedNumberFromBinary(data.slice(11, 13)) * 0.01,\r\n      discomfort_index: this.signedNumberFromBinary(data.slice(13, 15)) * 0.01,\r\n      heatstroke_risk_factor:\r\n        this.signedNumberFromBinary(data.slice(15, 17)) * 0.01,\r\n      battery_voltage:\r\n        this.unsignedNumberFromBinary(data.slice(17, 19)) * 0.001,\r\n    };\r\n\r\n    return json;\r\n  }\r\n}\r\n"]}