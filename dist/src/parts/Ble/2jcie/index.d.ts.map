{"version":3,"sources":["../src/parts/Ble/2jcie/index.ts"],"names":[],"mappings":"AAAA,OAAO,KAAK,MAAM,gBAAgB,CAAC;AAEnC,OAAO,mBAAmB,MAAM,oDAAoD,CAAC;AACrF,OAAO,mBAAmB,EAAE,EAAC,cAAc,EAAC,MAAM,oCAAoC,CAAC;AAEvF,MAAM,WAAW,kBAAkB;CAAG;AAEtC,MAAM,WAAW,gBAAgB;IAC/B,UAAU,EAAE,MAAM,CAAC;IACnB,WAAW,EAAE,MAAM,CAAC;IACpB,iBAAiB,EAAE,MAAM,CAAC;IAC1B,KAAK,EAAE,MAAM,CAAC;IACd,QAAQ,EAAE,MAAM,CAAC;IACjB,mBAAmB,EAAE,MAAM,CAAC;IAC5B,UAAU,EAAE,MAAM,CAAC;IACnB,gBAAgB,EAAE,MAAM,CAAC;IACzB,sBAAsB,EAAE,MAAM,CAAC;IAC/B,eAAe,EAAE,MAAM,CAAC;CACzB;AAED,MAAM,CAAC,OAAO,OAAO,WAAY,YAAW,mBAAmB;WAE/C,IAAI,IAAI,cAAc;IAM7B,IAAI,EAAE,MAAM,EAAE,CAAC;IACf,YAAY,EAAE,MAAM,EAAE,CAAC;IACvB,SAAS,EAAE,mBAAmB,GAAG,IAAI,CAAC;IACtC,KAAK,EAAG,KAAK,CAAC;;IAQd,KAAK,CAAC,KAAK,EAAE,KAAK;IAIZ,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC;IAU9B,UAAU,CAAC,IAAI,EAAE,MAAM,GAAG,MAAM;IAI1B,WAAW,IAAI,OAAO,CAAC,IAAI,CAAC;IAY5B,cAAc;IAMpB,sBAAsB,CAAC,IAAI,EAAE,MAAM,EAAE;IAYrC,wBAAwB,CAAC,IAAI,EAAE,MAAM,EAAE;IASjC,aAAa,IAAI,OAAO,CAAC,gBAAgB,CAAC;CAwBxD","file":"index.d.ts","sourcesContent":["import Obniz from \"../../../obniz\";\nimport bleRemoteCharacteristic from \"../../../obniz/libs/embeds/ble/bleRemoteCharacteristic\";\nimport bleRemotePeripheral from \"../../../obniz/libs/embeds/ble/bleRemotePeripheral\";\nimport ObnizPartsInterface, {ObnizPartsInfo} from \"../../../obniz/ObnizPartsInterface\";\n\nexport interface OMRON_2JCIEOptions {}\n\nexport interface OMRON_2JCIE_Data {\n  row_number: number;\n  temperature: number;\n  relative_humidity: number;\n  light: number;\n  uv_index: number;\n  barometric_pressure: number;\n  soud_noise: number;\n  discomfort_index: number;\n  heatstroke_risk_factor: number;\n  battery_voltage: number;\n}\n\nexport default class OMRON_2JCIE implements ObnizPartsInterface {\n\n  public static info(): ObnizPartsInfo {\n    return {\n      name: \"2JCIE\",\n    };\n  }\n\n  public keys: string[];\n  public requiredKeys: string[];\n  public periperal: bleRemotePeripheral | null;\n  public obniz!: Obniz;\n\n  constructor() {\n    this.keys = [];\n    this.requiredKeys = [];\n    this.periperal = null;\n  }\n\n  public wired(obniz: Obniz) {\n    this.obniz = obniz;\n  }\n\n  public async findWait(): Promise<any> {\n    const target: any = {\n      localName: \"Env\",\n    };\n\n    this.periperal = await this.obniz.ble!.scan.startOneWait(target);\n\n    return this.periperal;\n  }\n\n  public omron_uuid(uuid: string): string {\n    return `0C4C${uuid}-7700-46F4-AA96D5E974E32A54`;\n  }\n\n  public async connectWait(): Promise<void> {\n    if (!this.periperal) {\n      await this.findWait();\n    }\n    if (!this.periperal) {\n      throw new Error(\"2JCIE not found\");\n    }\n    if (!this.periperal.connected) {\n      await this.periperal.connectWait();\n    }\n  }\n\n  public async disconnectWait() {\n    if (this.periperal && this.periperal.connected) {\n      this.periperal.disconnectWait();\n    }\n  }\n\n  public signedNumberFromBinary(data: number[]) {\n    // little adian\n    let val: number = data[data.length - 1] & 0x7f;\n    for (let i = data.length - 2; i >= 0; i--) {\n      val = val * 256 + data[i];\n    }\n    if ((data[data.length - 1] & 0x80) !== 0) {\n      val = val - Math.pow(2, data.length * 8 - 1);\n    }\n    return val;\n  }\n\n  public unsignedNumberFromBinary(data: number[]) {\n    // little adian\n    let val: number = data[data.length - 1];\n    for (let i = data.length - 2; i >= 0; i--) {\n      val = val * 256 + data[i];\n    }\n    return val;\n  }\n\n  public async getLatestData(): Promise<OMRON_2JCIE_Data> {\n    await this.connectWait();\n\n    const c: bleRemoteCharacteristic = this.periperal!\n      .getService(this.omron_uuid(\"3000\"))\n      .getCharacteristic(this.omron_uuid(\"3001\"));\n    const data: number[] = await c.readWait();\n    const json: any = {\n      row_number: data[0],\n      temperature: this.signedNumberFromBinary(data.slice(1, 3)) * 0.01,\n      relative_humidity: this.signedNumberFromBinary(data.slice(3, 5)) * 0.01,\n      light: this.signedNumberFromBinary(data.slice(5, 7)) * 1,\n      uv_index: this.signedNumberFromBinary(data.slice(7, 9)) * 0.01,\n      barometric_pressure: this.signedNumberFromBinary(data.slice(9, 11)) * 0.1,\n      soud_noise: this.signedNumberFromBinary(data.slice(11, 13)) * 0.01,\n      discomfort_index: this.signedNumberFromBinary(data.slice(13, 15)) * 0.01,\n      heatstroke_risk_factor:\n        this.signedNumberFromBinary(data.slice(15, 17)) * 0.01,\n      battery_voltage:\n        this.unsignedNumberFromBinary(data.slice(17, 19)) * 0.001,\n    };\n\n    return json;\n  }\n}\n"]}