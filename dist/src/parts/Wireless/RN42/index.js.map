{"version":3,"sources":["../src/parts/Wireless/RN42/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import Obniz from \"../../../obniz\";\r\nimport PeripheralUART from \"../../../obniz/libs/io_peripherals/uart\";\r\n\r\nimport ObnizPartsInterface, {ObnizPartsInfo} from \"../../../obniz/ObnizPartsInterface\";\r\n\r\nexport interface RN42Options {\r\n  tx: number;\r\n  rx: number;\r\n  gnd?: number;\r\n}\r\n\r\nexport type RN42Config_Mode =\r\n  | \"slave\"\r\n  | \"master\"\r\n  | \"trigger\"\r\n  | \"auto-connect-master\"\r\n  | \"auto-connect-dtr\"\r\n  | \"auto-connect-any\"\r\n  | \"pairing\";\r\nexport type RN42Config_Profile = \"SPP\" | \"DUN-DCE\" | \"DUN-DTE\" | \"MDM-SPP\" | \"SPP-DUN-DCE\" | \"APL\" | \"HID\";\r\nexport type RN42Config_Auth = \"open\" | \"ssp-keyboard\" | \"just-work\" | \"pincode\";\r\nexport type RN43Config_Power = 16 | 12 | 8 | 4 | 0 | -4 | -8;\r\n\r\nexport interface RN42Config {\r\n  display_name?: string;\r\n  master_slave?: RN42Config_Mode;\r\n  profile?: RN42Config_Profile;\r\n  auth?: RN42Config_Auth;\r\n  power?: RN43Config_Power;\r\n  hid_flag?: any;\r\n}\r\n\r\nexport default class RN42 implements ObnizPartsInterface {\r\n\r\n  public static info(): ObnizPartsInfo {\r\n    return {\r\n      name: \"RN42\",\r\n    };\r\n  }\r\n\r\n  public keys: string[];\r\n  public requiredKeys: string[];\r\n  public params: any;\r\n\r\n  public onreceive?: (data: any, text: string) => void;\r\n\r\n  protected obniz!: Obniz;\r\n\r\n  private uart!: PeripheralUART;\r\n\r\n  constructor() {\r\n    this.keys = [\"tx\", \"rx\", \"gnd\"];\r\n    this.requiredKeys = [\"tx\", \"rx\"];\r\n  }\r\n\r\n  public wired(obniz: Obniz) {\r\n    if (obniz.isValidIO(this.params.gnd)) {\r\n      obniz.getIO(this.params.gnd).output(false);\r\n    }\r\n\r\n    this.uart = obniz.getFreeUart();\r\n\r\n    this.uart.start({\r\n      tx: this.params.tx,\r\n      rx: this.params.rx,\r\n      baud: 115200,\r\n      drive: \"3v\",\r\n    });\r\n\r\n    this.uart.onreceive = (data: any, text: any) => {\r\n      // this is not perfect. separation is possible.\r\n      if (text.indexOf(\"CONNECT\") >= 0) {\r\n        // console.log(\"connected\");\r\n      } else if (text.indexOf(\"DISCONNECT\") >= 0) {\r\n        // console.log(\"disconnected\");\r\n      }\r\n      if (typeof this.onreceive === \"function\") {\r\n        this.onreceive(data, text);\r\n      }\r\n    };\r\n  }\r\n\r\n  public send(data: any) {\r\n    this.uart.send(data);\r\n  }\r\n\r\n  public sendCommand(data: any) {\r\n    this.uart.send(data + \"\\n\");\r\n    this.obniz.wait(100);\r\n  }\r\n\r\n  public enterCommandMode() {\r\n    this.send(\"$$$\");\r\n    this.obniz.wait(100);\r\n  }\r\n\r\n  public config(json: RN42Config) {\r\n    this.enterCommandMode();\r\n    if (typeof json !== \"object\") {\r\n      // TODO: warning\r\n      return;\r\n    }\r\n    // remove noize data\r\n    this.sendCommand(\"\");\r\n\r\n    if (json.master_slave) {\r\n      this.config_masterslave(json.master_slave);\r\n    }\r\n    if (json.auth) {\r\n      this.config_auth(json.auth);\r\n    }\r\n    if (json.hid_flag) {\r\n      this.config_HIDflag(json.hid_flag);\r\n    }\r\n    if (json.profile) {\r\n      this.config_profile(json.profile);\r\n    }\r\n    if (json.power) {\r\n      this.config_power(json.power);\r\n    }\r\n    if (json.display_name) {\r\n      this.config_displayName(json.display_name);\r\n    }\r\n    this.config_reboot();\r\n  }\r\n\r\n  public config_reboot() {\r\n    this.sendCommand(\"R,1\");\r\n  }\r\n\r\n  public config_masterslave(mode: any) {\r\n    let val: any = -1;\r\n    if (typeof mode === \"number\") {\r\n      val = mode;\r\n    } else if (typeof mode === \"string\") {\r\n      const modes: any = [\r\n        \"slave\",\r\n        \"master\",\r\n        \"trigger\",\r\n        \"auto-connect-master\",\r\n        \"auto-connect-dtr\",\r\n        \"auto-connect-any\",\r\n        \"pairing\",\r\n      ];\r\n      for (let i = 0; i < modes.length; i++) {\r\n        if (modes[i] === mode) {\r\n          val = i;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    if (val === -1) {\r\n      // TODO: warning\r\n      return;\r\n    }\r\n    this.sendCommand(\"SM,\" + val);\r\n  }\r\n\r\n  public config_displayName(name: any) {\r\n    this.sendCommand(\"SN,\" + name);\r\n  }\r\n\r\n  // // SH,0200 HID Flag register. Descriptor=keyboard\r\n  public config_HIDflag(flag: any) {\r\n    this.sendCommand(\"SH,\" + flag);\r\n  }\r\n\r\n  public config_profile(mode: any) {\r\n    let val: any = -1;\r\n    if (typeof mode === \"number\") {\r\n      val = mode;\r\n    } else if (typeof mode === \"string\") {\r\n      const modes: any = [\r\n        \"SPP\",\r\n        \"DUN-DCE\",\r\n        \"DUN-DTE\",\r\n        \"MDM-SPP\",\r\n        \"SPP-DUN-DCE\",\r\n        \"APL\",\r\n        \"HID\",\r\n      ];\r\n      for (let i = 0; i < modes.length; i++) {\r\n        if (modes[i] === mode) {\r\n          val = i;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    if (val === -1) {\r\n      // TODO: warning\r\n      return;\r\n    }\r\n    this.sendCommand(\"S~,\" + val);\r\n  }\r\n\r\n  public config_revert_localecho() {\r\n    this.sendCommand(\"+\");\r\n  }\r\n\r\n  public config_auth(mode: any) {\r\n    let val: any = -1;\r\n    if (typeof mode === \"number\") {\r\n      val = mode;\r\n    } else if (typeof mode === \"string\") {\r\n      const modes: any = [\"open\", \"ssp-keyboard\", \"just-work\", \"pincode\"];\r\n      for (let i = 0; i < modes.length; i++) {\r\n        if (modes[i] === mode) {\r\n          val = i;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    if (val === -1) {\r\n      // TODO: warning\r\n      return;\r\n    }\r\n    this.sendCommand(\"SA,\" + val);\r\n  }\r\n\r\n  public config_power(dbm: any) {\r\n    let val: any = \"0010\";\r\n    if (16 > dbm && dbm >= 12) {\r\n      val = \"000C\";\r\n    } else if (12 > dbm && dbm >= 8) {\r\n      val = \"0008\";\r\n    } else if (8 > dbm && dbm >= 4) {\r\n      val = \"0004\";\r\n    } else if (4 > dbm && dbm >= 0) {\r\n      val = \"0000\";\r\n    } else if (0 > dbm && dbm >= -4) {\r\n      val = \"FFFC\";\r\n    } else if (-4 > dbm && dbm >= -8) {\r\n      val = \"FFF8\";\r\n    } else if (-8 > dbm) {\r\n      val = \"FFF4\";\r\n    }\r\n\r\n    this.sendCommand(\"SY,\" + val);\r\n  }\r\n\r\n  public config_get_setting() {\r\n    this.sendCommand(\"D\");\r\n  }\r\n\r\n  public config_get_extendSetting() {\r\n    this.sendCommand(\"E\");\r\n  }\r\n}\r\n"]}