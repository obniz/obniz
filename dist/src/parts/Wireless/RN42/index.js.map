{"version":3,"sources":["../src/parts/Wireless/RN42/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import Obniz from \"../../../obniz\";\nimport PeripheralUART from \"../../../obniz/libs/io_peripherals/uart\";\n\nimport ObnizPartsInterface, {ObnizPartsInfo} from \"../../../obniz/ObnizPartsInterface\";\n\nexport interface RN42Options {\n  tx: number;\n  rx: number;\n  gnd?: number;\n}\n\nexport type RN42Config_Mode =\n  | \"slave\"\n  | \"master\"\n  | \"trigger\"\n  | \"auto-connect-master\"\n  | \"auto-connect-dtr\"\n  | \"auto-connect-any\"\n  | \"pairing\";\nexport type RN42Config_Profile = \"SPP\" | \"DUN-DCE\" | \"DUN-DTE\" | \"MDM-SPP\" | \"SPP-DUN-DCE\" | \"APL\" | \"HID\";\nexport type RN42Config_Auth = \"open\" | \"ssp-keyboard\" | \"just-work\" | \"pincode\";\nexport type RN43Config_Power = 16 | 12 | 8 | 4 | 0 | -4 | -8;\n\nexport interface RN42Config {\n  display_name?: string;\n  master_slave?: RN42Config_Mode;\n  profile?: RN42Config_Profile;\n  auth?: RN42Config_Auth;\n  power?: RN43Config_Power;\n  hid_flag?: any;\n}\n\nexport default class RN42 implements ObnizPartsInterface {\n\n  public static info(): ObnizPartsInfo {\n    return {\n      name: \"RN42\",\n    };\n  }\n\n  public keys: string[];\n  public requiredKeys: string[];\n  public params: any;\n\n  public onreceive?: (data: any, text: string) => void;\n\n  protected obniz!: Obniz;\n\n  private uart!: PeripheralUART;\n\n  constructor() {\n    this.keys = [\"tx\", \"rx\", \"gnd\"];\n    this.requiredKeys = [\"tx\", \"rx\"];\n  }\n\n  public wired(obniz: Obniz) {\n    if (obniz.isValidIO(this.params.gnd)) {\n      obniz.getIO(this.params.gnd).output(false);\n    }\n\n    this.uart = obniz.getFreeUart();\n\n    this.uart.start({\n      tx: this.params.tx,\n      rx: this.params.rx,\n      baud: 115200,\n      drive: \"3v\",\n    });\n\n    this.uart.onreceive = (data: any, text: any) => {\n      // this is not perfect. separation is possible.\n      if (text.indexOf(\"CONNECT\") >= 0) {\n        // console.log(\"connected\");\n      } else if (text.indexOf(\"DISCONNECT\") >= 0) {\n        // console.log(\"disconnected\");\n      }\n      if (typeof this.onreceive === \"function\") {\n        this.onreceive(data, text);\n      }\n    };\n  }\n\n  public send(data: any) {\n    this.uart.send(data);\n  }\n\n  public sendCommand(data: any) {\n    this.uart.send(data + \"\\n\");\n    this.obniz.wait(100);\n  }\n\n  public enterCommandMode() {\n    this.send(\"$$$\");\n    this.obniz.wait(100);\n  }\n\n  public config(json: RN42Config) {\n    this.enterCommandMode();\n    if (typeof json !== \"object\") {\n      // TODO: warning\n      return;\n    }\n    // remove noize data\n    this.sendCommand(\"\");\n\n    if (json.master_slave) {\n      this.config_masterslave(json.master_slave);\n    }\n    if (json.auth) {\n      this.config_auth(json.auth);\n    }\n    if (json.hid_flag) {\n      this.config_HIDflag(json.hid_flag);\n    }\n    if (json.profile) {\n      this.config_profile(json.profile);\n    }\n    if (json.power) {\n      this.config_power(json.power);\n    }\n    if (json.display_name) {\n      this.config_displayName(json.display_name);\n    }\n    this.config_reboot();\n  }\n\n  public config_reboot() {\n    this.sendCommand(\"R,1\");\n  }\n\n  public config_masterslave(mode: any) {\n    let val: any = -1;\n    if (typeof mode === \"number\") {\n      val = mode;\n    } else if (typeof mode === \"string\") {\n      const modes: any = [\n        \"slave\",\n        \"master\",\n        \"trigger\",\n        \"auto-connect-master\",\n        \"auto-connect-dtr\",\n        \"auto-connect-any\",\n        \"pairing\",\n      ];\n      for (let i = 0; i < modes.length; i++) {\n        if (modes[i] === mode) {\n          val = i;\n          break;\n        }\n      }\n    }\n    if (val === -1) {\n      // TODO: warning\n      return;\n    }\n    this.sendCommand(\"SM,\" + val);\n  }\n\n  public config_displayName(name: any) {\n    this.sendCommand(\"SN,\" + name);\n  }\n\n  // // SH,0200 HID Flag register. Descriptor=keyboard\n  public config_HIDflag(flag: any) {\n    this.sendCommand(\"SH,\" + flag);\n  }\n\n  public config_profile(mode: any) {\n    let val: any = -1;\n    if (typeof mode === \"number\") {\n      val = mode;\n    } else if (typeof mode === \"string\") {\n      const modes: any = [\n        \"SPP\",\n        \"DUN-DCE\",\n        \"DUN-DTE\",\n        \"MDM-SPP\",\n        \"SPP-DUN-DCE\",\n        \"APL\",\n        \"HID\",\n      ];\n      for (let i = 0; i < modes.length; i++) {\n        if (modes[i] === mode) {\n          val = i;\n          break;\n        }\n      }\n    }\n    if (val === -1) {\n      // TODO: warning\n      return;\n    }\n    this.sendCommand(\"S~,\" + val);\n  }\n\n  public config_revert_localecho() {\n    this.sendCommand(\"+\");\n  }\n\n  public config_auth(mode: any) {\n    let val: any = -1;\n    if (typeof mode === \"number\") {\n      val = mode;\n    } else if (typeof mode === \"string\") {\n      const modes: any = [\"open\", \"ssp-keyboard\", \"just-work\", \"pincode\"];\n      for (let i = 0; i < modes.length; i++) {\n        if (modes[i] === mode) {\n          val = i;\n          break;\n        }\n      }\n    }\n    if (val === -1) {\n      // TODO: warning\n      return;\n    }\n    this.sendCommand(\"SA,\" + val);\n  }\n\n  public config_power(dbm: any) {\n    let val: any = \"0010\";\n    if (16 > dbm && dbm >= 12) {\n      val = \"000C\";\n    } else if (12 > dbm && dbm >= 8) {\n      val = \"0008\";\n    } else if (8 > dbm && dbm >= 4) {\n      val = \"0004\";\n    } else if (4 > dbm && dbm >= 0) {\n      val = \"0000\";\n    } else if (0 > dbm && dbm >= -4) {\n      val = \"FFFC\";\n    } else if (-4 > dbm && dbm >= -8) {\n      val = \"FFF8\";\n    } else if (-8 > dbm) {\n      val = \"FFF4\";\n    }\n\n    this.sendCommand(\"SY,\" + val);\n  }\n\n  public config_get_setting() {\n    this.sendCommand(\"D\");\n  }\n\n  public config_get_extendSetting() {\n    this.sendCommand(\"E\");\n  }\n}\n"]}