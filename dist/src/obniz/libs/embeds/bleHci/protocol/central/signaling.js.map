{"version":3,"sources":["../src/obniz/libs/embeds/bleHci/protocol/central/signaling.ts"],"names":[],"mappings":"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","file":"signaling.js","sourcesContent":["// let debug = require('debug')('signaling');\r\nconst debug: any = () => {\r\n};\r\n\r\nimport events from \"events\";\r\n\r\nconst CONNECTION_PARAMETER_UPDATE_REQUEST: any = 0x12;\r\nconst CONNECTION_PARAMETER_UPDATE_RESPONSE: any = 0x13;\r\n\r\nconst SIGNALING_CID: any = 0x0005;\r\n\r\nclass Signaling extends events.EventEmitter {\r\n  public _handle: any;\r\n  public _aclStream: any;\r\n  public onAclStreamDataBinded: any;\r\n  public onAclStreamEndBinded: any;\r\n\r\n  constructor(handle: any, aclStream: any) {\r\n    super();\r\n    this._handle = handle;\r\n    this._aclStream = aclStream;\r\n\r\n    this.onAclStreamDataBinded = this.onAclStreamData.bind(this);\r\n    this.onAclStreamEndBinded = this.onAclStreamEnd.bind(this);\r\n\r\n    this._aclStream.on(\"data\", this.onAclStreamDataBinded);\r\n    this._aclStream.on(\"end\", this.onAclStreamEndBinded);\r\n  }\r\n\r\n  public onAclStreamData(cid: any, data?: any) {\r\n    if (cid !== SIGNALING_CID) {\r\n      return;\r\n    }\r\n\r\n    debug(\"onAclStreamData: \" + data.toString(\"hex\"));\r\n\r\n    const code: any = data.readUInt8(0);\r\n    const identifier: any = data.readUInt8(1);\r\n    const length: any = data.readUInt16LE(2);\r\n    const signalingData: any = data.slice(4);\r\n\r\n    debug(\"\\tcode = \" + code);\r\n    debug(\"\\tidentifier = \" + identifier);\r\n    debug(\"\\tlength = \" + length);\r\n\r\n    if (code === CONNECTION_PARAMETER_UPDATE_REQUEST) {\r\n      this.processConnectionParameterUpdateRequest(identifier, signalingData);\r\n    }\r\n  }\r\n\r\n  public onAclStreamEnd() {\r\n    this._aclStream.removeListener(\"data\", this.onAclStreamDataBinded);\r\n    this._aclStream.removeListener(\"end\", this.onAclStreamEndBinded);\r\n  }\r\n\r\n  public processConnectionParameterUpdateRequest(identifier: any, data: any) {\r\n    const minInterval: any = data.readUInt16LE(0) * 1.25;\r\n    const maxInterval: any = data.readUInt16LE(2) * 1.25;\r\n    const latency: any = data.readUInt16LE(4);\r\n    const supervisionTimeout: any = data.readUInt16LE(6) * 10;\r\n\r\n    debug(\"\\t\\tmin interval = \", minInterval);\r\n    debug(\"\\t\\tmax interval = \", maxInterval);\r\n    debug(\"\\t\\tlatency = \", latency);\r\n    debug(\"\\t\\tsupervision timeout = \", supervisionTimeout);\r\n\r\n    const response: any = Buffer.alloc(6);\r\n\r\n    response.writeUInt8(CONNECTION_PARAMETER_UPDATE_RESPONSE, 0); // code\r\n    response.writeUInt8(identifier, 1); // identifier\r\n    response.writeUInt16LE(2, 2); // length\r\n    response.writeUInt16LE(0, 4);\r\n\r\n    this._aclStream.write(SIGNALING_CID, response);\r\n\r\n    this.emit(\r\n      \"connectionParameterUpdateRequest\",\r\n      this._handle,\r\n      minInterval,\r\n      maxInterval,\r\n      latency,\r\n      supervisionTimeout,\r\n    );\r\n  }\r\n}\r\n\r\nexport default Signaling;\r\n"]}