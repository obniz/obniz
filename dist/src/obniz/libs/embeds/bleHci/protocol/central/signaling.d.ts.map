{"version":3,"sources":["../src/obniz/libs/embeds/bleHci/protocol/central/signaling.ts"],"names":[],"mappings":";AAIA,OAAO,MAAM,MAAM,QAAQ,CAAC;AAO5B,cAAM,SAAU,SAAQ,MAAM,CAAC,YAAY;IAClC,OAAO,EAAE,GAAG,CAAC;IACb,UAAU,EAAE,GAAG,CAAC;IAChB,qBAAqB,EAAE,GAAG,CAAC;IAC3B,oBAAoB,EAAE,GAAG,CAAC;gBAErB,MAAM,EAAE,GAAG,EAAE,SAAS,EAAE,GAAG;IAYhC,eAAe,CAAC,GAAG,EAAE,GAAG,EAAE,IAAI,CAAC,EAAE,GAAG;IAqBpC,cAAc;IAKd,uCAAuC,CAAC,UAAU,EAAE,GAAG,EAAE,IAAI,EAAE,GAAG;CA6B1E;AAED,eAAe,SAAS,CAAC","file":"signaling.d.ts","sourcesContent":["// let debug = require('debug')('signaling');\r\nconst debug: any = () => {\r\n};\r\n\r\nimport events from \"events\";\r\n\r\nconst CONNECTION_PARAMETER_UPDATE_REQUEST: any = 0x12;\r\nconst CONNECTION_PARAMETER_UPDATE_RESPONSE: any = 0x13;\r\n\r\nconst SIGNALING_CID: any = 0x0005;\r\n\r\nclass Signaling extends events.EventEmitter {\r\n  public _handle: any;\r\n  public _aclStream: any;\r\n  public onAclStreamDataBinded: any;\r\n  public onAclStreamEndBinded: any;\r\n\r\n  constructor(handle: any, aclStream: any) {\r\n    super();\r\n    this._handle = handle;\r\n    this._aclStream = aclStream;\r\n\r\n    this.onAclStreamDataBinded = this.onAclStreamData.bind(this);\r\n    this.onAclStreamEndBinded = this.onAclStreamEnd.bind(this);\r\n\r\n    this._aclStream.on(\"data\", this.onAclStreamDataBinded);\r\n    this._aclStream.on(\"end\", this.onAclStreamEndBinded);\r\n  }\r\n\r\n  public onAclStreamData(cid: any, data?: any) {\r\n    if (cid !== SIGNALING_CID) {\r\n      return;\r\n    }\r\n\r\n    debug(\"onAclStreamData: \" + data.toString(\"hex\"));\r\n\r\n    const code: any = data.readUInt8(0);\r\n    const identifier: any = data.readUInt8(1);\r\n    const length: any = data.readUInt16LE(2);\r\n    const signalingData: any = data.slice(4);\r\n\r\n    debug(\"\\tcode = \" + code);\r\n    debug(\"\\tidentifier = \" + identifier);\r\n    debug(\"\\tlength = \" + length);\r\n\r\n    if (code === CONNECTION_PARAMETER_UPDATE_REQUEST) {\r\n      this.processConnectionParameterUpdateRequest(identifier, signalingData);\r\n    }\r\n  }\r\n\r\n  public onAclStreamEnd() {\r\n    this._aclStream.removeListener(\"data\", this.onAclStreamDataBinded);\r\n    this._aclStream.removeListener(\"end\", this.onAclStreamEndBinded);\r\n  }\r\n\r\n  public processConnectionParameterUpdateRequest(identifier: any, data: any) {\r\n    const minInterval: any = data.readUInt16LE(0) * 1.25;\r\n    const maxInterval: any = data.readUInt16LE(2) * 1.25;\r\n    const latency: any = data.readUInt16LE(4);\r\n    const supervisionTimeout: any = data.readUInt16LE(6) * 10;\r\n\r\n    debug(\"\\t\\tmin interval = \", minInterval);\r\n    debug(\"\\t\\tmax interval = \", maxInterval);\r\n    debug(\"\\t\\tlatency = \", latency);\r\n    debug(\"\\t\\tsupervision timeout = \", supervisionTimeout);\r\n\r\n    const response: any = Buffer.alloc(6);\r\n\r\n    response.writeUInt8(CONNECTION_PARAMETER_UPDATE_RESPONSE, 0); // code\r\n    response.writeUInt8(identifier, 1); // identifier\r\n    response.writeUInt16LE(2, 2); // length\r\n    response.writeUInt16LE(0, 4);\r\n\r\n    this._aclStream.write(SIGNALING_CID, response);\r\n\r\n    this.emit(\r\n      \"connectionParameterUpdateRequest\",\r\n      this._handle,\r\n      minInterval,\r\n      maxInterval,\r\n      latency,\r\n      supervisionTimeout,\r\n    );\r\n  }\r\n}\r\n\r\nexport default Signaling;\r\n"]}