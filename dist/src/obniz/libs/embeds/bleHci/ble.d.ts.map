{"version":3,"sources":["../src/obniz/libs/embeds/bleHci/ble.ts"],"names":[],"mappings":"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","file":"ble.d.ts","sourcesContent":["import BleHelper from \"./bleHelper\";\nimport ObnizBLEHci from \"./hci\";\nimport CentralBindings from \"./protocol/central/bindings\";\nimport HciProtocol from \"./protocol/hci\";\nimport PeripheralBindings from \"./protocol/peripheral/bindings\";\n\nimport Obniz from \"../../../index\";\nimport BleAdvertisement from \"./bleAdvertisement\";\nimport BleCharacteristic from \"./bleCharacteristic\";\nimport BleDescriptor from \"./bleDescriptor\";\nimport BlePeripheral from \"./blePeripheral\";\nimport BleRemotePeripheral from \"./bleRemotePeripheral\";\nimport BleScan from \"./bleScan\";\nimport BleSecurity from \"./bleSecurity\";\nimport BleService from \"./bleService\";\nimport {BleDeviceAddressType, UUID} from \"./bleTypes\";\n\nclass ObnizBLE {\n\n  public static _dataArray2uuidHex(data: number[], reverse: boolean): UUID {\n    let uuid: any = [];\n    for (let i = 0; i < data.length; i++) {\n      uuid.push((\"00\" + data[i].toString(16).toLowerCase()).slice(-2));\n    }\n    if (reverse) {\n      uuid = uuid.reverse();\n    }\n    let str: any = uuid.join(\"\");\n    if (uuid.length >= 16) {\n      str =\n        str.slice(0, 8) +\n        \"-\" +\n        str.slice(8, 12) +\n        \"-\" +\n        str.slice(12, 16) +\n        \"-\" +\n        str.slice(16, 20) +\n        \"-\" +\n        str.slice(20);\n    }\n    return str;\n  }\n\n  public Obniz: Obniz;\n  public hci: ObnizBLEHci;\n  public hciProtocol: HciProtocol;\n  public centralBindings: CentralBindings;\n  public peripheralBindings: PeripheralBindings;\n  public _initialized: boolean;\n  public _initializeWarning: boolean;\n  public remotePeripherals: BleRemotePeripheral[];\n  public service: typeof BleService;\n  public characteristic: typeof BleCharacteristic;\n  public descriptor: typeof BleDescriptor;\n  public peripheral: BlePeripheral;\n  public advertisement: any;\n  public scan: BleScan;\n  public security: any;\n\n  constructor(obniz: Obniz) {\n    this.Obniz = obniz;\n    this.hci = new ObnizBLEHci(obniz);\n    this.hciProtocol = new HciProtocol(this.hci);\n\n    this.centralBindings = new CentralBindings(this.hciProtocol);\n    this.peripheralBindings = new PeripheralBindings(this.hciProtocol);\n\n    // let dummy = {write : ()=>{}, on:()=>{}}\n    // this.centralBindings = new CentralBindings( dummy );\n    // this.peripheralBindings = new PeripheralBindings( dummy );\n\n    this.centralBindings.init();\n    this.peripheralBindings.init();\n\n    this._initialized = false;\n    this._initializeWarning = true;\n\n    this.remotePeripherals = [];\n\n    this.service = BleService;\n    this.characteristic = BleCharacteristic;\n    this.descriptor = BleDescriptor;\n    this.peripheral = new BlePeripheral(this);\n\n    this.advertisement = new BleAdvertisement(this);\n    this.scan = new BleScan(this);\n    this.security = new BleSecurity(this);\n\n    this._bind();\n    this._reset();\n  }\n\n  public async initWait(): Promise<void> {\n    if (!this._initialized) {\n      this._initialized = true;\n      await this.hciProtocol.initWait();\n    }\n  }\n\n  public warningIfNotInitialize() {\n    if (!this._initialized && this._initializeWarning) {\n      this._initializeWarning = true;\n      this.Obniz.warning({\n        alert: \"warning\",\n        message: `BLE is not initialized. Please call 'await obniz.ble.initWait()'`,\n      });\n    }\n  }\n\n  public notified(obj: any) {\n    if (obj.hci) {\n      this.hci.notified(obj.hci);\n    }\n  }\n\n  public _reset() {\n  }\n\n  public directConnect(uuid: UUID, addressType: BleDeviceAddressType) {\n    let peripheral: any = this.findPeripheral(uuid);\n    if (!peripheral) {\n      peripheral = new BleRemotePeripheral(this, uuid);\n      this.remotePeripherals.push(peripheral);\n    }\n    if (!this.centralBindings._addresses[uuid]) {\n      const address: any = uuid.match(/.{1,2}/g)!.join(\":\");\n      this.centralBindings._addresses[uuid] = address;\n      this.centralBindings._addresseTypes[uuid] = addressType;\n      this.centralBindings._connectable[uuid] = true;\n    }\n    peripheral.connect();\n    return peripheral;\n  }\n\n  public async directConnectWait(uuid: any, addressType: any) {\n    const peripheral: any = this.directConnect(uuid, addressType);\n    await peripheral.connectWait();\n    return peripheral;\n  }\n\n  public findPeripheral(address: any) {\n    for (const key in this.remotePeripherals) {\n      if (this.remotePeripherals[key].address === address) {\n        return this.remotePeripherals[key];\n      }\n    }\n    return null;\n  }\n\n  public onStateChange() {\n  }\n\n  public onAddressChange() {\n  }\n\n  public onScanStart() {\n  }\n\n  public onScanStop() {\n    this.scan.notifyFromServer(\"onfinish\", null);\n  }\n\n  public onDiscover(uuid: any, address?: any, addressType?: any, connectable?: any, advertisement?: any, rssi?: any) {\n    let val: any = this.findPeripheral(uuid);\n    if (!val) {\n      val = new BleRemotePeripheral(this, uuid);\n      this.remotePeripherals.push(val);\n    }\n    val.discoverdOnRemote = true;\n\n    const peripheralData: any = {\n      device_type: \"ble\",\n      address_type: addressType,\n      ble_event_type: connectable\n        ? \"connectable_advertisemnt\"\n        : \"non_connectable_advertising\",\n      rssi,\n      adv_data: advertisement.advertisementRaw,\n      scan_resp: advertisement.scanResponseRaw,\n    };\n\n    val.setParams(peripheralData);\n    val._adv_data_filtered = advertisement;\n\n    this.scan.notifyFromServer(\"onfind\", val);\n  }\n\n  public async onConnect(peripheralUuid: any, error?: any) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    if (!error) {\n      await peripheral.discoverAllHandlesWait();\n    }\n    peripheral.notifyFromServer(\"statusupdate\", {\n      status: error ? \"disconnected\" : \"connected\",\n    });\n  }\n\n  public onDisconnect(peripheralUuid: any) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    peripheral.notifyFromServer(\"statusupdate\", {status: \"disconnected\"});\n  }\n\n  public onRssiUpdate() {\n  }\n\n  public onServicesDiscover(peripheralUuid: any, serviceUuids?: any) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    for (const serviceUuid of serviceUuids) {\n      peripheral.notifyFromServer(\"discover\", {service_uuid: serviceUuid});\n    }\n    peripheral.notifyFromServer(\"discoverfinished\", {});\n  }\n\n  public onIncludedServicesDiscover(\n    peripheralUuid: any,\n    serviceUuid?: any,\n    includedServiceUuids?: any,\n  ) {\n  }\n\n  public onCharacteristicsDiscover(peripheralUuid: any, serviceUuid?: any, characteristics?: any) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    const service: any = peripheral.findService({service_uuid: serviceUuid});\n    for (const char of characteristics) {\n      const obj: any = {\n        properties: char.properties.map((e: any) => BleHelper.toSnakeCase(e)),\n        characteristic_uuid: char.uuid,\n      };\n      service.notifyFromServer(\"discover\", obj);\n    }\n    service.notifyFromServer(\"discoverfinished\", {});\n  }\n\n  public onRead(\n    peripheralUuid: any,\n    serviceUuid?: any,\n    characteristicUuid?: any,\n    data?: any,\n    isNotification?: any,\n    isSuccess?: any,\n  ) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    const characteristic: any = peripheral.findCharacteristic({\n      service_uuid: serviceUuid,\n      characteristic_uuid: characteristicUuid,\n    });\n\n    if (isNotification) {\n      const obj: any = {\n        data: Array.from(data),\n      };\n      characteristic.notifyFromServer(\"onnotify\", obj);\n    } else {\n      const obj: any = {\n        result: isSuccess ? \"success\" : \"failed\",\n        data: Array.from(data),\n      };\n      characteristic.notifyFromServer(\"onread\", obj);\n    }\n  }\n\n  public onWrite(peripheralUuid: any, serviceUuid?: any, characteristicUuid?: any, isSuccess?: any) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    const characteristic: any = peripheral.findCharacteristic({\n      service_uuid: serviceUuid,\n      characteristic_uuid: characteristicUuid,\n    });\n    characteristic.notifyFromServer(\"onwrite\", {\n      result: isSuccess ? \"success\" : \"failed\",\n    });\n  }\n\n  public onBroadcast(peripheralUuid: any, serviceUuid?: any, characteristicUuid?: any, state?: any) {\n  }\n\n  public onNotify(peripheralUuid: any, serviceUuid?: any, characteristicUuid?: any, state?: any) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    const char: any = peripheral.findCharacteristic({\n      service_uuid: serviceUuid,\n      characteristic_uuid: characteristicUuid,\n    });\n\n    if (state) {\n      char.notifyFromServer(\"onregisternotify\", {});\n    } else {\n      char.notifyFromServer(\"onunregisternotify\", {});\n    }\n  }\n\n  public onDescriptorsDiscover(\n    peripheralUuid: any,\n    serviceUuid?: any,\n    characteristicUuid?: any,\n    descriptors?: any,\n  ) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    const char: any = peripheral.findCharacteristic({\n      service_uuid: serviceUuid,\n      characteristic_uuid: characteristicUuid,\n    });\n    for (const descr of descriptors) {\n      const obj: any = {\n        descriptor_uuid: descr,\n      };\n      char.notifyFromServer(\"discover\", obj);\n    }\n    char.notifyFromServer(\"discoverfinished\", {});\n  }\n\n  public onValueRead(\n    peripheralUuid: any,\n    serviceUuid?: any,\n    characteristicUuid?: any,\n    descriptorUuid?: any,\n    data?: any,\n    isSuccess?: any,\n  ) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    const descriptor: any = peripheral.findDescriptor({\n      service_uuid: serviceUuid,\n      characteristic_uuid: characteristicUuid,\n      descriptor_uuid: descriptorUuid,\n    });\n\n    const obj: any = {\n      result: isSuccess ? \"success\" : \"failed\",\n      data: Array.from(data),\n    };\n    descriptor.notifyFromServer(\"onread\", obj);\n  }\n\n  public onValueWrite(\n    peripheralUuid: any,\n    serviceUuid?: any,\n    characteristicUuid?: any,\n    descriptorUuid?: any,\n    isSuccess?: any,\n  ) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    const descriptor: any = peripheral.findDescriptor({\n      service_uuid: serviceUuid,\n      characteristic_uuid: characteristicUuid,\n      descriptor_uuid: descriptorUuid,\n    });\n\n    const obj: any = {\n      result: isSuccess ? \"success\" : \"failed\",\n    };\n    descriptor.notifyFromServer(\"onwrite\", obj);\n  }\n\n  public onHandleRead(peripheralUuid: any, handle?: any, data?: any) {\n  }\n\n  public onHandleWrite(peripheralUuid: any, handle?: any) {\n  }\n\n  public onHandleNotify(peripheralUuid: any, handle?: any, data?: any) {\n  }\n\n  public onPeripheralStateChange(state: any) {\n    // console.error(\"onPeripheralStateChange\")\n  }\n\n  public onPeripheralAddressChange(address: any) {\n    // console.error(\"onPeripheralAddressChange\")\n  }\n\n  public onPeripheralPlatform(platform: any) {\n    // console.error(\"onPeripheralPlatform\")\n  }\n\n  public onPeripheralAdvertisingStart(error: any) {\n    // console.error(\"onPeripheralAdvertisingStart\")\n  }\n\n  public onPeripheralAdvertisingStop() {\n    // console.error(\"onPeripheralAdvertisingStop\")\n  }\n\n  public onPeripheralServicesSet(error: any) {\n    // console.error(\"onPeripheralServicesSet\")\n  }\n\n  public onPeripheralAccept(clientAddress: any) {\n    this.peripheral.currentConnectedDeviceAddress = clientAddress;\n    this.peripheral.onconnectionupdates({\n      address: clientAddress,\n      status: \"connected\",\n    });\n  }\n\n  public onPeripheralMtuChange(mtu: any) {\n    // console.error(\"onPeripheralMtuChange\")\n  }\n\n  public onPeripheralDisconnect(clientAddress: any) {\n    this.peripheral.currentConnectedDeviceAddress = null;\n    this.peripheral.onconnectionupdates({\n      address: clientAddress,\n      status: \"disconnected\",\n    });\n  }\n\n  public onPeripheralRssiUpdate(rssi: any) {\n    // console.error(\"onPeripheralRssiUpdate\")\n  }\n\n  public _bind() {\n    this.centralBindings.on(\"stateChange\", this.onStateChange.bind(this));\n\n    this.centralBindings.on(\"addressChange\", this.onAddressChange.bind(this));\n\n    this.centralBindings.on(\"scanStart\", this.onScanStart.bind(this));\n    this.centralBindings.on(\"scanStop\", this.onScanStop.bind(this));\n    this.centralBindings.on(\"discover\", this.onDiscover.bind(this));\n    this.centralBindings.on(\"connect\", this.onConnect.bind(this));\n    this.centralBindings.on(\"disconnect\", this.onDisconnect.bind(this));\n    this.centralBindings.on(\"rssiUpdate\", this.onRssiUpdate.bind(this));\n    this.centralBindings.on(\n      \"servicesDiscover\",\n      this.onServicesDiscover.bind(this),\n    );\n    this.centralBindings.on(\n      \"includedServicesDiscover\",\n      this.onIncludedServicesDiscover.bind(this),\n    );\n    this.centralBindings.on(\n      \"characteristicsDiscover\",\n      this.onCharacteristicsDiscover.bind(this),\n    );\n\n    this.centralBindings.on(\"read\", this.onRead.bind(this));\n    this.centralBindings.on(\"write\", this.onWrite.bind(this));\n    this.centralBindings.on(\"broadcast\", this.onBroadcast.bind(this));\n    this.centralBindings.on(\"notify\", this.onNotify.bind(this));\n    this.centralBindings.on(\n      \"descriptorsDiscover\",\n      this.onDescriptorsDiscover.bind(this),\n    );\n    this.centralBindings.on(\"valueRead\", this.onValueRead.bind(this));\n    this.centralBindings.on(\"valueWrite\", this.onValueWrite.bind(this));\n    this.centralBindings.on(\"handleRead\", this.onHandleRead.bind(this));\n    this.centralBindings.on(\"handleWrite\", this.onHandleWrite.bind(this));\n    this.centralBindings.on(\"handleNotify\", this.onHandleNotify.bind(this));\n\n    this.peripheralBindings.on(\n      \"stateChange\",\n      this.onPeripheralStateChange.bind(this),\n    );\n    this.peripheralBindings.on(\n      \"addressChange\",\n      this.onPeripheralAddressChange.bind(this),\n    );\n    this.peripheralBindings.on(\n      \"platform\",\n      this.onPeripheralPlatform.bind(this),\n    );\n    this.peripheralBindings.on(\n      \"advertisingStart\",\n      this.onPeripheralAdvertisingStart.bind(this),\n    );\n    this.peripheralBindings.on(\n      \"advertisingStop\",\n      this.onPeripheralAdvertisingStop.bind(this),\n    );\n    this.peripheralBindings.on(\n      \"servicesSet\",\n      this.onPeripheralServicesSet.bind(this),\n    );\n    this.peripheralBindings.on(\"accept\", this.onPeripheralAccept.bind(this));\n    this.peripheralBindings.on(\n      \"mtuChange\",\n      this.onPeripheralMtuChange.bind(this),\n    );\n    this.peripheralBindings.on(\n      \"disconnect\",\n      this.onPeripheralDisconnect.bind(this),\n    );\n\n    this.peripheralBindings.on(\n      \"rssiUpdate\",\n      this.onPeripheralRssiUpdate.bind(this),\n    );\n  }\n}\n\nexport default ObnizBLE;\n"]}