{"version":3,"sources":["../src/obniz/libs/wscommand/WSCommand.ts"],"names":[],"mappings":";;;;;AAAA,0DAAkC;AAElC,MAAM,cAAc,GAAQ,EAAE,CAAC;AAE/B,MAA8B,SAAS;IAuHrC;QACE,IAAI,CAAC,GAAG,GAAG;YACT,EAAE,EAAE,SAAS;YACb,QAAQ,EAAE,SAAS;SACpB,CAAC;QAEF,YAAY;QACZ,IAAI,CAAC,qBAAqB,GAAG,IAAI,CAAC;QAClC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;IACxB,CAAC;IA9HD,MAAM,KAAK,MAAM;QACf,OAAO,kBAAQ,CAAC;IAClB,CAAC;IAED,MAAM,KAAK,cAAc;QACvB,OAAO,cAAc,CAAC;IACxB,CAAC;IAED,IAAI,sBAAsB;QACxB,OAAO,sBAAsB,CAAC;IAChC,CAAC;IAEM,MAAM,CAAC,eAAe,CAAC,IAAS,EAAE,QAAa;QACpD,cAAc,CAAC,IAAI,CAAC,GAAG,QAAQ,CAAC;IAClC,CAAC;IAEM,MAAM,CAAC,MAAM,CAAC,MAAW,EAAE,IAAS,EAAE,OAAY;QACvD,IAAI,cAAc,GAAQ,CAAC,CAAC;QAC5B,IAAI,OAAO,EAAE;YACX,cAAc,GAAG,OAAO,CAAC,MAAM,CAAC;SACjC;QACD,IAAI,WAAgB,CAAC;QACrB,IAAI,cAAc,IAAI,IAAI,EAAE;YAC1B,WAAW,GAAG,CAAC,CAAC;SACjB;aAAM,IAAI,cAAc,IAAI,MAAM,EAAE;YACnC,WAAW,GAAG,CAAC,CAAC;SACjB;aAAM,IAAI,cAAc,IAAI,UAAU,EAAE;YACvC,WAAW,GAAG,CAAC,CAAC;SACjB;aAAM;YACL,MAAM,IAAI,KAAK,CAAC,iBAAiB,CAAC,CAAC;SACpC;QACD,IAAI,kBAAkB,GAAQ,WAAW,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAChF,MAAM,aAAa,GAAQ,CAAC,GAAG,kBAAkB,CAAC;QAClD,MAAM,MAAM,GAAQ,IAAI,UAAU,CAAC,aAAa,GAAG,cAAc,CAAC,CAAC;QACnE,IAAI,KAAK,GAAQ,CAAC,CAAC;QACnB,MAAM,CAAC,KAAK,EAAE,CAAC,GAAG,MAAM,GAAG,IAAI,CAAC;QAChC,MAAM,CAAC,KAAK,EAAE,CAAC,GAAG,IAAI,CAAC;QACvB,MAAM,CAAC,KAAK,EAAE,CAAC;YACb,CAAC,WAAW,IAAI,CAAC,CAAC,GAAG,CAAC,cAAc,IAAI,CAAC,kBAAkB,GAAG,CAAC,CAAC,CAAC,CAAC;QACpE,OAAO,kBAAkB,GAAG,CAAC,EAAE;YAC7B,kBAAkB,EAAE,CAAC;YACrB,MAAM,CAAC,KAAK,EAAE,CAAC,GAAG,cAAc,IAAI,CAAC,kBAAkB,GAAG,CAAC,CAAC,CAAC;SAC9D;QACD,IAAI,cAAc,KAAK,CAAC,EAAE;YACxB,OAAO,MAAM,CAAC;SACf;aAAM;YACL,MAAM,CAAC,GAAG,CAAC,OAAO,EAAE,aAAa,CAAC,CAAC;YACnC,OAAO,MAAM,CAAC;SACf;IACH,CAAC;IAEM,MAAM,CAAC,UAAU,CAAC,GAAQ;QAC/B,IAAI,CAAC,GAAG,IAAI,GAAG,CAAC,UAAU,KAAK,CAAC,EAAE;YAChC,OAAO,IAAI,CAAC;SACb;QACD,IAAI,GAAG,CAAC,UAAU,GAAG,CAAC,EAAE;YACtB,MAAM,IAAI,KAAK,CAAC,kCAAkC,CAAC,CAAC;SACrD;QACD,IAAI,GAAG,CAAC,CAAC,CAAC,GAAG,IAAI,EAAE;YACjB,MAAM,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAAC;SACnC;QACD,MAAM,MAAM,GAAQ,IAAI,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC;QAClC,MAAM,IAAI,GAAQ,GAAG,CAAC,CAAC,CAAC,CAAC;QACzB,MAAM,WAAW,GAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,GAAG,GAAG,CAAC;QAC7C,MAAM,kBAAkB,GAAQ,WAAW,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAClF,IAAI,WAAW,KAAK,CAAC,EAAE;YACrB,MAAM,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAAC;SACnC;QACD,IAAI,MAAM,GAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,kBAAkB,GAAG,CAAC,CAAC,CAAC;QAC9D,IAAI,KAAK,GAAQ,CAAC,CAAC;QACnB,IAAI,KAAK,GAAQ,kBAAkB,CAAC;QACpC,OAAO,KAAK,GAAG,CAAC,EAAE;YAChB,KAAK,EAAE,CAAC;YACR,MAAM,IAAI,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC;YACpC,KAAK,EAAE,CAAC;SACT;QAED,OAAO;YACL,MAAM;YACN,IAAI;YACJ,OAAO,EAAE,GAAG,CAAC,KAAK,CAChB,CAAC,GAAG,kBAAkB,EACtB,CAAC,GAAG,kBAAkB,GAAG,MAAM,CAChC;YACD,IAAI,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC,GAAG,kBAAkB,GAAG,MAAM,CAAC;SACjD,CAAC;IACJ,CAAC;IAEM,MAAM,CAAC,QAAQ,CAAC,UAAe,EAAE,IAAS;QAC/C,IAAI,GAAG,GAAQ,IAAI,CAAC;QAEpB,SAAS,MAAM,CAAC,MAAW,EAAE,IAAS,EAAE,OAAY;YAClD,MAAM,KAAK,GAAQ,SAAS,CAAC,MAAM,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,CAAC,CAAC;YAC3D,IAAI,GAAG,EAAE;gBACP,MAAM,QAAQ,GAAQ,IAAI,UAAU,CAAC,GAAG,CAAC,MAAM,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC;gBAChE,QAAQ,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;gBACrB,QAAQ,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC;gBAChC,GAAG,GAAG,QAAQ,CAAC;aAChB;iBAAM;gBACL,GAAG,GAAG,KAAK,CAAC;aACb;QACH,CAAC;QAED,KAAK,MAAM,SAAS,IAAI,UAAU,EAAE;YAClC,SAAS,CAAC,MAAM,GAAG,MAAM,CAAC;YAC1B,SAAS,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;SAC/B;QACD,OAAO,GAAG,CAAC;IACb,CAAC;IAoBM,KAAK,CAAC,GAAQ;QACnB,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC;IACjB,CAAC;IAEM,WAAW,CAAC,IAAS,EAAE,OAAY;QACxC,IAAI,IAAI,CAAC,MAAM,EAAE;YACf,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,CAAC,CAAC;SACzC;IACH,CAAC;IAEM,aAAa,CAAC,IAAS;QAC5B,WAAW;IACb,CAAC;IAEM,gBAAgB,CAAC,SAAc,EAAE,IAAS,EAAE,OAAY;QAC7D,IAAI,IAAI,KAAK,IAAI,CAAC,qBAAqB,EAAE;YACvC,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE;gBACpB,SAAS,CAAC,KAAK,GAAG,EAAE,CAAC;aACtB;YACD,MAAM,GAAG,GAAQ;gBACf,MAAM,EAAE,IAAI,CAAC,MAAM;gBACnB,KAAK,EAAE,CAAC,GAAG,OAAO,CAAC;aACpB,CAAC;YAEF,IAAI,OAAO,CAAC,UAAU,KAAK,CAAC,EAAE;gBAC5B,GAAG,CAAC,IAAI,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;gBACtB,GAAG,CAAC,IAAI,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;gBACtB,GAAG,CAAC,QAAQ,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;gBAC1B,GAAG,CAAC,OAAO,GAAG,gBAAgB,IAAI,CAAC,MAAM,SAAS,GAAG,CAAC,QAAQ,SAC5D,GAAG,CAAC,IACN,aAAa,GAAG,CAAC,IAAI,EAAE,CAAC;aACzB;iBAAM;gBACL,GAAG,CAAC,OAAO,GAAG,gBAAgB,IAAI,CAAC,MAAM,WAAW,GAAG,CAAC,KAAK,EAAE,CAAC;aACjE;YACD,SAAS,CAAC,KAAK,CAAC,KAAK,GAAG,GAAG,CAAC;SAC7B;aAAM;YACL,UAAU;SACX;IACH,CAAC;IAEM,cAAc,CAAC,SAAc,EAAE,UAAe,EAAE,GAAQ;QAC7D,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,EAAE;YAC1B,SAAS,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC;SAC5B;QACD,SAAS,CAAC,UAAU,CAAC,CAAC,OAAO,GAAG,GAAG,CAAC;IACtC,CAAC;IAEM,YAAY,CAAC,SAAc,EAAE,UAAe,EAAE,GAAQ;QAC3D,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,EAAE;YAC1B,SAAS,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC;SAC5B;QACD,SAAS,CAAC,UAAU,CAAC,CAAC,KAAK,GAAG,GAAG,CAAC;IACpC,CAAC;IAEM,SAAS,CAAC,EAAO;QACtB,OAAO,OAAO,EAAE,KAAK,QAAQ,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC;IACvD,CAAC;IAEM,SAAS,CAAC,GAAQ;QACvB,gBAAgB;QAEhB,OAAO,kBAAQ,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;IACjC,CAAC;IAEM,qBAAqB,CAAC,OAAY,EAAE,IAAS,EAAE,QAAa,EAAE,SAAc;QACjF,MAAM,GAAG,GAAQ,EAAC,KAAK,EAAE,CAAC,EAAE,OAAO,EAAE,CAAC,EAAE,OAAO,EAAE,EAAE,EAAE,cAAc,EAAE,EAAE,EAAC,CAAC;QACzE,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE;YAC5B,MAAM,MAAM,GAAQ,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;YACpD,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YACzB,IAAI,MAAM,CAAC,KAAK,EAAE;gBAChB,GAAG,CAAC,KAAK,EAAE,CAAC;gBACZ,IAAI,MAAM,CAAC,OAAO,EAAE;oBAClB,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,GAAG,EAAE,IAAI,CAAC,EAAE,SAAS,CAAC,CAAC;iBACrE;aACF;iBAAM;gBACL,GAAG,CAAC,OAAO,EAAE,CAAC;gBACd,MAAM,OAAO,GAAQ,IAAI,CAAC,oBAAoB,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;gBACjE,IAAI,OAAO,EAAE;oBACX,GAAG,CAAC,cAAc,CAAC,IAAI,CAAC,EAAC,GAAG,EAAE,MAAM,CAAC,GAAG,EAAE,OAAO,EAAC,CAAC,CAAC;iBACrD;aACF;SACF;QAED,OAAO,GAAG,CAAC;IACb,CAAC;IAEM,QAAQ,CAAC,UAAe,EAAE,IAAS;QACxC,MAAM,MAAM,GAAQ,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;QAC/C,MAAM,OAAO,GAAQ,kBAAQ,CAAC,gBAAgB,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;QAC7D,OAAO,OAAO,CAAC;IACjB,CAAC;IAEM,oBAAoB,CAAC,aAAkB,EAAE,QAAa;QAC3D,IAAI,aAAa,CAAC,KAAK,EAAE;YACvB,OAAO,IAAI,CAAC;SACb;QACD,IAAI,aAAa,CAAC,OAAO,IAAI,aAAa,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE;YAC7D,OAAO,KAAK,CAAC;SACd;QAED,MAAM,aAAa,GAAQ;YACzB,kBAAQ,CAAC,UAAU,CAAC,cAAc;YAClC,kBAAQ,CAAC,UAAU,CAAC,cAAc;YAClC,kBAAQ,CAAC,UAAU,CAAC,eAAe;YACnC,kBAAQ,CAAC,UAAU,CAAC,UAAU;YAC9B,kBAAQ,CAAC,UAAU,CAAC,eAAe;YACnC,kBAAQ,CAAC,UAAU,CAAC,4BAA4B;YAChD,kBAAQ,CAAC,UAAU,CAAC,kBAAkB;YACtC,kBAAQ,CAAC,UAAU,CAAC,aAAa;YACjC,kBAAQ,CAAC,UAAU,CAAC,cAAc;YAClC,kBAAQ,CAAC,UAAU,CAAC,gBAAgB;SACrC,CAAC;QACF,MAAM,QAAQ,GAAQ,EAAE,CAAC;QACzB,KAAK,MAAM,KAAK,IAAI,aAAa,CAAC,MAAM,EAAE;YACxC,IAAI,KAAK,CAAC,IAAI,KAAK,kBAAQ,CAAC,UAAU,CAAC,YAAY,EAAE;gBACnD,IACG,KAAa,CAAC,MAAM,CAAC,IAAI,KAAK,QAAQ;oBACtC,KAAa,CAAC,MAAM,CAAC,QAAQ,KAAK,QAAQ,EAC3C;oBACA,OAAO,KAAK,CAAC;iBACd;aACF;iBAAM,IAAI,aAAa,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;gBAC7C,OAAO,KAAK,CAAC;aACd;YAED,MAAM,IAAI,GAAQ,QAAQ,GAAG,CAAC,KAAK,CAAC,QAAQ,IAAI,EAAE,CAAC,CAAC,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;YACxE,QAAQ,CAAC,IAAI,CAAC,IAAI,IAAI,IAAI,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;SAC5C;QACD,OAAO,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IAC5B,CAAC;IAEM,MAAM,CAAC,UAAe,EAAE,IAAS;QACtC,MAAM,MAAM,GAAQ,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;QAC/C,OAAO,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;IAC1C,CAAC;IAEM,aAAa,CAAC,MAAW,EAAE,IAAS;QACzC,IAAI,MAAM,CAAC,IAAI,EAAE;YACf,MAAM,SAAS,GAAQ,kBAAQ,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YACvD,OAAO,IAAI,CAAC,aAAa,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;SAC5C;QAED,IAAI,IAAI,KAAK,SAAS,EAAE;YACtB,OAAO,MAAM,CAAC,OAAO,CAAC;SACvB;QAED,IACE,MAAM,CAAC,IAAI,KAAK,QAAQ;YACxB,MAAM,CAAC,IAAI,KAAK,SAAS;YACzB,MAAM,CAAC,IAAI,KAAK,SAAS;YACzB,MAAM,CAAC,IAAI,KAAK,QAAQ;YACxB,MAAM,CAAC,IAAI,KAAK,MAAM;YACtB,MAAM,CAAC,MAAM,KAAK,UAAU,EAC5B;YACA,OAAO,IAAI,CAAC;SACb;QAED,IAAI,MAAM,CAAC,IAAI,KAAK,OAAO,EAAE;YAC3B,MAAM,OAAO,GAAQ,EAAE,CAAC;YACxB,KAAK,MAAM,GAAG,IAAI,IAAI,EAAE;gBACtB,OAAO,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,KAAK,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;aAC5D;YACD,OAAO,OAAO,CAAC;SAChB;QAED,IAAI,MAAM,CAAC,IAAI,KAAK,QAAQ,EAAE;YAC5B,MAAM,OAAO,GAAQ,EAAE,CAAC;YACxB,KAAK,MAAM,GAAG,IAAI,MAAM,CAAC,UAAU,EAAE;gBACnC,OAAO,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;aACtE;YAED,KAAK,MAAM,OAAO,IAAI,MAAM,CAAC,iBAAiB,EAAE;gBAC9C,MAAM,GAAG,GAAQ,IAAI,MAAM,CAAC,OAAO,CAAC,CAAC;gBACrC,KAAK,MAAM,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;oBACnC,IAAI,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE;wBACjB,OAAO,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,aAAa,CAC/B,MAAM,CAAC,iBAAiB,CAAC,OAAO,CAAC,EACjC,IAAI,CAAC,GAAG,CAAC,CACV,CAAC;qBACH;iBACF;aACF;YACD,OAAO,OAAO,CAAC;SAChB;QAED,MAAM,KAAK,CAAC,0BAA0B,CAAC,CAAC;IAC1C,CAAC;CACF;AA7TD,4BA6TC;AAED,gDAAgD;AAChD,MAAM,sBAAuB,SAAQ,KAAK;CACzC","file":"WSCommand.js","sourcesContent":["import WSSchema from \"./WSSchema\";\n\nconst commandClasses: any = {};\n\nexport default abstract class WSCommand {\n\n  static get schema() {\n    return WSSchema;\n  }\n\n  static get CommandClasses() {\n    return commandClasses;\n  }\n\n  get WSCommandNotFoundError() {\n    return WSCommandNotFoundError;\n  }\n\n  public static addCommandClass(name: any, classObj: any) {\n    commandClasses[name] = classObj;\n  }\n\n  public static framed(module: any, func: any, payload: any): Uint8Array {\n    let payload_length: any = 0;\n    if (payload) {\n      payload_length = payload.length;\n    }\n    let length_type: any;\n    if (payload_length <= 0x3f) {\n      length_type = 0;\n    } else if (payload_length <= 0x3fff) {\n      length_type = 1;\n    } else if (payload_length <= 0x3fffffff) {\n      length_type = 2;\n    } else {\n      throw new Error(\"too big payload\");\n    }\n    let length_extra_bytse: any = length_type === 0 ? 0 : length_type === 1 ? 1 : 3;\n    const header_length: any = 3 + length_extra_bytse;\n    const result: any = new Uint8Array(header_length + payload_length);\n    let index: any = 0;\n    result[index++] = module & 0x7f;\n    result[index++] = func;\n    result[index++] =\n      (length_type << 6) | (payload_length >> (length_extra_bytse * 8));\n    while (length_extra_bytse > 0) {\n      length_extra_bytse--;\n      result[index++] = payload_length >> (length_extra_bytse * 8);\n    }\n    if (payload_length === 0) {\n      return result;\n    } else {\n      result.set(payload, header_length);\n      return result;\n    }\n  }\n\n  public static dequeueOne(buf: any) {\n    if (!buf || buf.byteLength === 0) {\n      return null;\n    }\n    if (buf.byteLength < 3) {\n      throw new Error(\"something wrong. buf less than 3\");\n    }\n    if (buf[0] & 0x80) {\n      throw new Error(\"reserved bit 1\");\n    }\n    const module: any = 0x7f & buf[0];\n    const func: any = buf[1];\n    const length_type: any = (buf[2] >> 6) & 0x3;\n    const length_extra_bytse: any = length_type === 0 ? 0 : length_type === 1 ? 1 : 3;\n    if (length_type === 4) {\n      throw new Error(\"invalid length\");\n    }\n    let length: any = (buf[2] & 0x3f) << (length_extra_bytse * 8);\n    let index: any = 3;\n    let shift: any = length_extra_bytse;\n    while (shift > 0) {\n      shift--;\n      length += buf[index] << (shift * 8);\n      index++;\n    }\n\n    return {\n      module,\n      func,\n      payload: buf.slice(\n        3 + length_extra_bytse,\n        3 + length_extra_bytse + length,\n      ),\n      next: buf.slice(3 + length_extra_bytse + length),\n    };\n  }\n\n  public static compress(wscommands: any, json: any): Uint8Array | null {\n    let ret: any = null;\n\n    function append(module: any, func: any, payload: any) {\n      const frame: any = WSCommand.framed(module, func, payload);\n      if (ret) {\n        const combined: any = new Uint8Array(ret.length + frame.length);\n        combined.set(ret, 0);\n        combined.set(frame, ret.length);\n        ret = combined;\n      } else {\n        ret = frame;\n      }\n    }\n\n    for (const wscommand of wscommands) {\n      wscommand.parsed = append;\n      wscommand.parseFromJson(json);\n    }\n    return ret;\n  }\n\n  public _hw: any;\n  public ioNotUsed: number;\n  public COMMAND_FUNC_ID_ERROR: number;\n\n  protected abstract module: number;\n  private parsed?: (module: number, func: number, payload: Uint8Array) => void;\n\n  constructor() {\n    this._hw = {\n      hw: undefined,\n      firmware: undefined,\n    };\n\n    // constants\n    this.COMMAND_FUNC_ID_ERROR = 0xff;\n    this.ioNotUsed = 0xff;\n  }\n\n  public setHw(obj: any) {\n    this._hw = obj;\n  }\n\n  public sendCommand(func: any, payload: any) {\n    if (this.parsed) {\n      this.parsed(this.module, func, payload);\n    }\n  }\n\n  public parseFromJson(json: any) {\n    // abstract\n  }\n\n  public notifyFromBinary(objToSend: any, func: any, payload: any) {\n    if (func === this.COMMAND_FUNC_ID_ERROR) {\n      if (!objToSend.debug) {\n        objToSend.debug = {};\n      }\n      const err: any = {\n        module: this.module,\n        _args: [...payload],\n      };\n\n      if (payload.byteLength === 3) {\n        err.err0 = payload[0];\n        err.err1 = payload[1];\n        err.function = payload[2];\n        err.message = `Error module=${this.module} func=${err.function} err0=${\n          err.err0\n        } returned=${err.err1}`;\n      } else {\n        err.message = `Error module=${this.module} with + ${err._args}`;\n      }\n      objToSend.debug.error = err;\n    } else {\n      // unknown\n    }\n  }\n\n  public envelopWarning(objToSend: any, module_key: any, obj: any) {\n    if (!objToSend[module_key]) {\n      objToSend[module_key] = {};\n    }\n    objToSend[module_key].warning = obj;\n  }\n\n  public envelopError(objToSend: any, module_key: any, obj: any) {\n    if (!objToSend[module_key]) {\n      objToSend[module_key] = {};\n    }\n    objToSend[module_key].error = obj;\n  }\n\n  public isValidIO(io: any) {\n    return typeof io === \"number\" && 0 <= io && io <= 11;\n  }\n\n  public getSchema(uri: any) {\n    // chack isFirst\n\n    return WSSchema.getSchema(uri);\n  }\n\n  public validateCommandSchema(uriList: any, json: any, rootPath: any, customArg: any) {\n    const res: any = {valid: 0, invalid: 0, results: [], invalidButLike: []};\n    for (const oneRow of uriList) {\n      const errors: any = this.validate(oneRow.uri, json);\n      res.results.push(errors);\n      if (errors.valid) {\n        res.valid++;\n        if (oneRow.onValid) {\n          oneRow.onValid.bind(this)(this.filter(oneRow.uri, json), customArg);\n        }\n      } else {\n        res.invalid++;\n        const message: any = this.onlyTypeErrorMessage(errors, rootPath);\n        if (message) {\n          res.invalidButLike.push({uri: oneRow.uri, message});\n        }\n      }\n    }\n\n    return res;\n  }\n\n  public validate(commandUri: any, json: any): WSSchema.MultiResult {\n    const schema: any = this.getSchema(commandUri);\n    const results: any = WSSchema.validateMultiple(json, schema);\n    return results;\n  }\n\n  public onlyTypeErrorMessage(validateError: any, rootPath: any) {\n    if (validateError.valid) {\n      return true;\n    }\n    if (validateError.missing && validateError.missing.length > 0) {\n      return false;\n    }\n\n    const badErrorCodes: any = [\n      WSSchema.errorCodes.ANY_OF_MISSING,\n      WSSchema.errorCodes.ONE_OF_MISSING,\n      WSSchema.errorCodes.ONE_OF_MULTIPLE,\n      WSSchema.errorCodes.NOT_PASSED,\n      WSSchema.errorCodes.OBJECT_REQUIRED,\n      WSSchema.errorCodes.OBJECT_ADDITIONAL_PROPERTIES,\n      WSSchema.errorCodes.CIRCULAR_REFERENCE,\n      WSSchema.errorCodes.FORMAT_CUSTOM,\n      WSSchema.errorCodes.KEYWORD_CUSTOM,\n      WSSchema.errorCodes.UNKNOWN_PROPERTY,\n    ];\n    const messages: any = [];\n    for (const error of validateError.errors) {\n      if (error.code === WSSchema.errorCodes.INVALID_TYPE) {\n        if (\n          (error as any).params.type === \"object\" ||\n          (error as any).params.expected === \"object\"\n        ) {\n          return false;\n        }\n      } else if (badErrorCodes.includes(error.code)) {\n        return false;\n      }\n\n      const path: any = rootPath + (error.dataPath || \"\").replace(/\\//g, \".\");\n      messages.push(`[${path}]${error.message}`);\n    }\n    return messages.join(\";\");\n  }\n\n  public filter(commandUri: any, json: any) {\n    const schema: any = this.getSchema(commandUri);\n    return this._filterSchema(schema, json);\n  }\n\n  public _filterSchema(schema: any, json: any): any {\n    if (schema.$ref) {\n      const refSchema: any = WSSchema.getSchema(schema.$ref);\n      return this._filterSchema(refSchema, json);\n    }\n\n    if (json === undefined) {\n      return schema.default;\n    }\n\n    if (\n      schema.type === \"string\" ||\n      schema.type === \"integer\" ||\n      schema.type === \"boolean\" ||\n      schema.type === \"number\" ||\n      schema.type === \"null\" ||\n      schema.filter === \"pass_all\"\n    ) {\n      return json;\n    }\n\n    if (schema.type === \"array\") {\n      const results: any = [];\n      for (const key in json) {\n        results[key] = this._filterSchema(schema.items, json[key]);\n      }\n      return results;\n    }\n\n    if (schema.type === \"object\") {\n      const results: any = {};\n      for (const key in schema.properties) {\n        results[key] = this._filterSchema(schema.properties[key], json[key]);\n      }\n\n      for (const pattern in schema.patternProperties) {\n        const reg: any = new RegExp(pattern);\n        for (const key of Object.keys(json)) {\n          if (reg.test(key)) {\n            results[key] = this._filterSchema(\n              schema.patternProperties[pattern],\n              json[key],\n            );\n          }\n        }\n      }\n      return results;\n    }\n\n    throw Error(\"unknown json schema type\");\n  }\n}\n\n// tslint:disable-next-line:max-classes-per-file\nclass WSCommandNotFoundError extends Error {\n}\n"]}