{"version":3,"sources":["../src/obniz/libs/wscommand/WSCommand.ts"],"names":[],"mappings":"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","file":"WSCommand.js","sourcesContent":["import WSSchema from \"./WSSchema\";\r\n\r\nconst commandClasses: any = {};\r\n\r\nexport default abstract class WSCommand {\r\n\r\n  static get schema() {\r\n    return WSSchema;\r\n  }\r\n\r\n  static get CommandClasses() {\r\n    return commandClasses;\r\n  }\r\n\r\n  get WSCommandNotFoundError() {\r\n    return WSCommandNotFoundError;\r\n  }\r\n\r\n  public static addCommandClass(name: any, classObj: any) {\r\n    commandClasses[name] = classObj;\r\n  }\r\n\r\n  public static framed(module: any, func: any, payload: any): Uint8Array {\r\n    let payload_length: any = 0;\r\n    if (payload) {\r\n      payload_length = payload.length;\r\n    }\r\n    let length_type: any;\r\n    if (payload_length <= 0x3f) {\r\n      length_type = 0;\r\n    } else if (payload_length <= 0x3fff) {\r\n      length_type = 1;\r\n    } else if (payload_length <= 0x3fffffff) {\r\n      length_type = 2;\r\n    } else {\r\n      throw new Error(\"too big payload\");\r\n    }\r\n    let length_extra_bytse: any = length_type === 0 ? 0 : length_type === 1 ? 1 : 3;\r\n    const header_length: any = 3 + length_extra_bytse;\r\n    const result: any = new Uint8Array(header_length + payload_length);\r\n    let index: any = 0;\r\n    result[index++] = module & 0x7f;\r\n    result[index++] = func;\r\n    result[index++] =\r\n      (length_type << 6) | (payload_length >> (length_extra_bytse * 8));\r\n    while (length_extra_bytse > 0) {\r\n      length_extra_bytse--;\r\n      result[index++] = payload_length >> (length_extra_bytse * 8);\r\n    }\r\n    if (payload_length === 0) {\r\n      return result;\r\n    } else {\r\n      result.set(payload, header_length);\r\n      return result;\r\n    }\r\n  }\r\n\r\n  public static dequeueOne(buf: any) {\r\n    if (!buf || buf.byteLength === 0) {\r\n      return null;\r\n    }\r\n    if (buf.byteLength < 3) {\r\n      throw new Error(\"something wrong. buf less than 3\");\r\n    }\r\n    if (buf[0] & 0x80) {\r\n      throw new Error(\"reserved bit 1\");\r\n    }\r\n    const module: any = 0x7f & buf[0];\r\n    const func: any = buf[1];\r\n    const length_type: any = (buf[2] >> 6) & 0x3;\r\n    const length_extra_bytse: any = length_type === 0 ? 0 : length_type === 1 ? 1 : 3;\r\n    if (length_type === 4) {\r\n      throw new Error(\"invalid length\");\r\n    }\r\n    let length: any = (buf[2] & 0x3f) << (length_extra_bytse * 8);\r\n    let index: any = 3;\r\n    let shift: any = length_extra_bytse;\r\n    while (shift > 0) {\r\n      shift--;\r\n      length += buf[index] << (shift * 8);\r\n      index++;\r\n    }\r\n\r\n    return {\r\n      module,\r\n      func,\r\n      payload: buf.slice(\r\n        3 + length_extra_bytse,\r\n        3 + length_extra_bytse + length,\r\n      ),\r\n      next: buf.slice(3 + length_extra_bytse + length),\r\n    };\r\n  }\r\n\r\n  public static compress(wscommands: any, json: any): Uint8Array | null {\r\n    let ret: any = null;\r\n\r\n    function append(module: any, func: any, payload: any) {\r\n      const frame: any = WSCommand.framed(module, func, payload);\r\n      if (ret) {\r\n        const combined: any = new Uint8Array(ret.length + frame.length);\r\n        combined.set(ret, 0);\r\n        combined.set(frame, ret.length);\r\n        ret = combined;\r\n      } else {\r\n        ret = frame;\r\n      }\r\n    }\r\n\r\n    for (const wscommand of wscommands) {\r\n      wscommand.parsed = append;\r\n      wscommand.parseFromJson(json);\r\n    }\r\n    return ret;\r\n  }\r\n\r\n  public _hw: any;\r\n  public ioNotUsed: number;\r\n  public COMMAND_FUNC_ID_ERROR: number;\r\n\r\n  protected abstract module: number;\r\n  private parsed?: (module: number, func: number, payload: Uint8Array) => void;\r\n\r\n  constructor() {\r\n    this._hw = {\r\n      hw: undefined,\r\n      firmware: undefined,\r\n    };\r\n\r\n    // constants\r\n    this.COMMAND_FUNC_ID_ERROR = 0xff;\r\n    this.ioNotUsed = 0xff;\r\n  }\r\n\r\n  public setHw(obj: any) {\r\n    this._hw = obj;\r\n  }\r\n\r\n  public sendCommand(func: any, payload: any) {\r\n    if (this.parsed) {\r\n      this.parsed(this.module, func, payload);\r\n    }\r\n  }\r\n\r\n  public parseFromJson(json: any) {\r\n    // abstract\r\n  }\r\n\r\n  public notifyFromBinary(objToSend: any, func: any, payload: any) {\r\n    if (func === this.COMMAND_FUNC_ID_ERROR) {\r\n      if (!objToSend.debug) {\r\n        objToSend.debug = {};\r\n      }\r\n      const err: any = {\r\n        module: this.module,\r\n        _args: [...payload],\r\n      };\r\n\r\n      if (payload.byteLength === 3) {\r\n        err.err0 = payload[0];\r\n        err.err1 = payload[1];\r\n        err.function = payload[2];\r\n        err.message = `Error module=${this.module} func=${err.function} err0=${\r\n          err.err0\r\n        } returned=${err.err1}`;\r\n      } else {\r\n        err.message = `Error module=${this.module} with + ${err._args}`;\r\n      }\r\n      objToSend.debug.error = err;\r\n    } else {\r\n      // unknown\r\n    }\r\n  }\r\n\r\n  public envelopWarning(objToSend: any, module_key: any, obj: any) {\r\n    if (!objToSend[module_key]) {\r\n      objToSend[module_key] = {};\r\n    }\r\n    objToSend[module_key].warning = obj;\r\n  }\r\n\r\n  public envelopError(objToSend: any, module_key: any, obj: any) {\r\n    if (!objToSend[module_key]) {\r\n      objToSend[module_key] = {};\r\n    }\r\n    objToSend[module_key].error = obj;\r\n  }\r\n\r\n  public isValidIO(io: any) {\r\n    return typeof io === \"number\" && 0 <= io && io <= 11;\r\n  }\r\n\r\n  public getSchema(uri: any) {\r\n    // chack isFirst\r\n\r\n    return WSSchema.getSchema(uri);\r\n  }\r\n\r\n  public validateCommandSchema(uriList: any, json: any, rootPath: any, customArg: any) {\r\n    const res: any = {valid: 0, invalid: 0, results: [], invalidButLike: []};\r\n    for (const oneRow of uriList) {\r\n      const errors: any = this.validate(oneRow.uri, json);\r\n      res.results.push(errors);\r\n      if (errors.valid) {\r\n        res.valid++;\r\n        if (oneRow.onValid) {\r\n          oneRow.onValid.bind(this)(this.filter(oneRow.uri, json), customArg);\r\n        }\r\n      } else {\r\n        res.invalid++;\r\n        const message: any = this.onlyTypeErrorMessage(errors, rootPath);\r\n        if (message) {\r\n          res.invalidButLike.push({uri: oneRow.uri, message});\r\n        }\r\n      }\r\n    }\r\n\r\n    return res;\r\n  }\r\n\r\n  public validate(commandUri: any, json: any): WSSchema.MultiResult {\r\n    const schema: any = this.getSchema(commandUri);\r\n    const results: any = WSSchema.validateMultiple(json, schema);\r\n    return results;\r\n  }\r\n\r\n  public onlyTypeErrorMessage(validateError: any, rootPath: any) {\r\n    if (validateError.valid) {\r\n      return true;\r\n    }\r\n    if (validateError.missing && validateError.missing.length > 0) {\r\n      return false;\r\n    }\r\n\r\n    const badErrorCodes: any = [\r\n      WSSchema.errorCodes.ANY_OF_MISSING,\r\n      WSSchema.errorCodes.ONE_OF_MISSING,\r\n      WSSchema.errorCodes.ONE_OF_MULTIPLE,\r\n      WSSchema.errorCodes.NOT_PASSED,\r\n      WSSchema.errorCodes.OBJECT_REQUIRED,\r\n      WSSchema.errorCodes.OBJECT_ADDITIONAL_PROPERTIES,\r\n      WSSchema.errorCodes.CIRCULAR_REFERENCE,\r\n      WSSchema.errorCodes.FORMAT_CUSTOM,\r\n      WSSchema.errorCodes.KEYWORD_CUSTOM,\r\n      WSSchema.errorCodes.UNKNOWN_PROPERTY,\r\n    ];\r\n    const messages: any = [];\r\n    for (const error of validateError.errors) {\r\n      if (error.code === WSSchema.errorCodes.INVALID_TYPE) {\r\n        if (\r\n          (error as any).params.type === \"object\" ||\r\n          (error as any).params.expected === \"object\"\r\n        ) {\r\n          return false;\r\n        }\r\n      } else if (badErrorCodes.includes(error.code)) {\r\n        return false;\r\n      }\r\n\r\n      const path: any = rootPath + (error.dataPath || \"\").replace(/\\//g, \".\");\r\n      messages.push(`[${path}]${error.message}`);\r\n    }\r\n    return messages.join(\";\");\r\n  }\r\n\r\n  public filter(commandUri: any, json: any) {\r\n    const schema: any = this.getSchema(commandUri);\r\n    return this._filterSchema(schema, json);\r\n  }\r\n\r\n  public _filterSchema(schema: any, json: any): any {\r\n    if (schema.$ref) {\r\n      const refSchema: any = WSSchema.getSchema(schema.$ref);\r\n      return this._filterSchema(refSchema, json);\r\n    }\r\n\r\n    if (json === undefined) {\r\n      return schema.default;\r\n    }\r\n\r\n    if (\r\n      schema.type === \"string\" ||\r\n      schema.type === \"integer\" ||\r\n      schema.type === \"boolean\" ||\r\n      schema.type === \"number\" ||\r\n      schema.type === \"null\" ||\r\n      schema.filter === \"pass_all\"\r\n    ) {\r\n      return json;\r\n    }\r\n\r\n    if (schema.type === \"array\") {\r\n      const results: any = [];\r\n      for (const key in json) {\r\n        results[key] = this._filterSchema(schema.items, json[key]);\r\n      }\r\n      return results;\r\n    }\r\n\r\n    if (schema.type === \"object\") {\r\n      const results: any = {};\r\n      for (const key in schema.properties) {\r\n        results[key] = this._filterSchema(schema.properties[key], json[key]);\r\n      }\r\n\r\n      for (const pattern in schema.patternProperties) {\r\n        const reg: any = new RegExp(pattern);\r\n        for (const key of Object.keys(json)) {\r\n          if (reg.test(key)) {\r\n            results[key] = this._filterSchema(\r\n              schema.patternProperties[pattern],\r\n              json[key],\r\n            );\r\n          }\r\n        }\r\n      }\r\n      return results;\r\n    }\r\n\r\n    throw Error(\"unknown json schema type\");\r\n  }\r\n}\r\n\r\n// tslint:disable-next-line:max-classes-per-file\r\nclass WSCommandNotFoundError extends Error {\r\n}\r\n"]}