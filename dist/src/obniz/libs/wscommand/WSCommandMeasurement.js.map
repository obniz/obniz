{"version":3,"sources":["../src/obniz/libs/wscommand/WSCommandMeasurement.ts"],"names":[],"mappings":"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","file":"WSCommandMeasurement.js","sourcesContent":["import WSCommand from \"./WSCommand\";\n\nclass WSCommandMeasurement extends WSCommand {\n  public module: any;\n  public _CommandMeasurementEcho: any;\n  public sendCommand: any;\n  public validateCommandSchema: any;\n  public WSCommandNotFoundError: any;\n\n  constructor() {\n    super();\n    this.module = 12;\n\n    this._CommandMeasurementEcho = 0;\n  }\n\n  // Commands\n\n  public echo(params: any) {\n    const triggerIO: any = params.echo.io_pulse;\n    const triggerPosNeg: any = params.echo.pulse === \"negative\" ? false : true;\n    const triggerWidthUs: any = Math.floor(params.echo.pulse_width * 1000);\n    const echoIO: any = params.echo.io_echo;\n    const responseCount: any = params.echo.measure_edges;\n    let timeoutUs: any = params.echo.timeout * 1000;\n    timeoutUs = parseInt(timeoutUs);\n\n    const buf: any = new Uint8Array(13);\n    buf[0] = 0;\n    buf[1] = triggerIO;\n    buf[2] = triggerPosNeg ? 1 : 0;\n    buf[3] = triggerWidthUs >> (8 * 3);\n    buf[4] = triggerWidthUs >> (8 * 2);\n    buf[5] = triggerWidthUs >> 8;\n    buf[6] = triggerWidthUs;\n    buf[7] = echoIO;\n    buf[8] = responseCount;\n    buf[9] = timeoutUs >> (8 * 3);\n    buf[10] = timeoutUs >> (8 * 2);\n    buf[11] = timeoutUs >> 8;\n    buf[12] = timeoutUs;\n    this.sendCommand(this._CommandMeasurementEcho, buf);\n  }\n\n  public parseFromJson(json: any) {\n    const module: any = json.measure;\n    if (module === undefined) {\n      return;\n    }\n    const schemaData: any = [{uri: \"/request/measure/echo\", onValid: this.echo}];\n    const res: any = this.validateCommandSchema(schemaData, module, \"measure\");\n\n    if (res.valid === 0) {\n      if (res.invalidButLike.length > 0) {\n        throw new Error(res.invalidButLike[0].message);\n      } else {\n        throw new this.WSCommandNotFoundError(`[measure]unknown command`);\n      }\n    }\n  }\n\n  public notifyFromBinary(objToSend: any, func: any, payload: any) {\n    if (func === this._CommandMeasurementEcho) {\n      let index: any = 0;\n      const count: any = parseInt(payload[index++]);\n      const array: any = [];\n      for (let i = 0; i < count; i++) {\n        let timing: any;\n        const edge: any = payload[index++] > 0 ? true : false;\n        timing = payload[index++] << (8 * 3);\n        timing += payload[index++] << (8 * 2);\n        timing += payload[index++] << 8;\n        timing += payload[index++];\n        timing = timing / 1000;\n        array.push({\n          edge,\n          timing,\n        });\n      }\n      objToSend.measure = {\n        echo: array,\n      };\n    } else {\n      super.notifyFromBinary(objToSend, func, payload);\n    }\n  }\n}\n\nexport default WSCommandMeasurement;\n"]}