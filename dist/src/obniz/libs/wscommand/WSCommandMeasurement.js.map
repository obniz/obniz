{"version":3,"sources":["../src/obniz/libs/wscommand/WSCommandMeasurement.ts"],"names":[],"mappings":"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","file":"WSCommandMeasurement.js","sourcesContent":["import WSCommand from \"./WSCommand\";\r\n\r\nclass WSCommandMeasurement extends WSCommand {\r\n  public module: any;\r\n  public _CommandMeasurementEcho: any;\r\n  public sendCommand: any;\r\n  public validateCommandSchema: any;\r\n  public WSCommandNotFoundError: any;\r\n\r\n  constructor() {\r\n    super();\r\n    this.module = 12;\r\n\r\n    this._CommandMeasurementEcho = 0;\r\n  }\r\n\r\n  // Commands\r\n\r\n  public echo(params: any) {\r\n    const triggerIO: any = params.echo.io_pulse;\r\n    const triggerPosNeg: any = params.echo.pulse === \"negative\" ? false : true;\r\n    const triggerWidthUs: any = Math.floor(params.echo.pulse_width * 1000);\r\n    const echoIO: any = params.echo.io_echo;\r\n    const responseCount: any = params.echo.measure_edges;\r\n    let timeoutUs: any = params.echo.timeout * 1000;\r\n    timeoutUs = parseInt(timeoutUs);\r\n\r\n    const buf: any = new Uint8Array(13);\r\n    buf[0] = 0;\r\n    buf[1] = triggerIO;\r\n    buf[2] = triggerPosNeg ? 1 : 0;\r\n    buf[3] = triggerWidthUs >> (8 * 3);\r\n    buf[4] = triggerWidthUs >> (8 * 2);\r\n    buf[5] = triggerWidthUs >> 8;\r\n    buf[6] = triggerWidthUs;\r\n    buf[7] = echoIO;\r\n    buf[8] = responseCount;\r\n    buf[9] = timeoutUs >> (8 * 3);\r\n    buf[10] = timeoutUs >> (8 * 2);\r\n    buf[11] = timeoutUs >> 8;\r\n    buf[12] = timeoutUs;\r\n    this.sendCommand(this._CommandMeasurementEcho, buf);\r\n  }\r\n\r\n  public parseFromJson(json: any) {\r\n    const module: any = json.measure;\r\n    if (module === undefined) {\r\n      return;\r\n    }\r\n    const schemaData: any = [{uri: \"/request/measure/echo\", onValid: this.echo}];\r\n    const res: any = this.validateCommandSchema(schemaData, module, \"measure\");\r\n\r\n    if (res.valid === 0) {\r\n      if (res.invalidButLike.length > 0) {\r\n        throw new Error(res.invalidButLike[0].message);\r\n      } else {\r\n        throw new this.WSCommandNotFoundError(`[measure]unknown command`);\r\n      }\r\n    }\r\n  }\r\n\r\n  public notifyFromBinary(objToSend: any, func: any, payload: any) {\r\n    if (func === this._CommandMeasurementEcho) {\r\n      let index: any = 0;\r\n      const count: any = parseInt(payload[index++]);\r\n      const array: any = [];\r\n      for (let i = 0; i < count; i++) {\r\n        let timing: any;\r\n        const edge: any = payload[index++] > 0 ? true : false;\r\n        timing = payload[index++] << (8 * 3);\r\n        timing += payload[index++] << (8 * 2);\r\n        timing += payload[index++] << 8;\r\n        timing += payload[index++];\r\n        timing = timing / 1000;\r\n        array.push({\r\n          edge,\r\n          timing,\r\n        });\r\n      }\r\n      objToSend.measure = {\r\n        echo: array,\r\n      };\r\n    } else {\r\n      super.notifyFromBinary(objToSend, func, payload);\r\n    }\r\n  }\r\n}\r\n\r\nexport default WSCommandMeasurement;\r\n"]}